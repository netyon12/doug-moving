{% extends "base.html" %}

{% block title %}{{ 'Editar' if empresa else 'Cadastrar' }} Empresa{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3>{{ 'Editar Empresa' if empresa else 'Cadastrar Nova Empresa' }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.editar_empresa', empresa_id=empresa.id) if empresa else url_for('admin.cadastrar_empresa') }}">
                        
                        <div class="row">
                            <!-- S√ì MOSTRA O C√ìDIGO SE ESTIVER EDITANDO -->
                            {% if empresa %}
                            <div class="col-md-4 mb-3">
                                <label for="codigo" class="form-label">C√≥digo da Empresa</label>
                                <input type="text" class="form-control" id="codigo" value="{{ empresa.id }}" readonly style="background-color: #e9ecef;">
                            </div>
                            {% endif %}

                            <!-- O campo Nome agora ocupa o espa√ßo restante -->
                            <div class="col-md-{{ '8' if empresa else '12' }} mb-3">
                                <label for="nome" class="form-label">Nome da Empresa*</label>
                                <input type="text" class="form-control" id="nome" name="nome" value="{{ empresa.nome if empresa else '' }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="cnpj" class="form-label">CNPJ</label>
                                <input type="text" class="form-control" id="cnpj" name="cnpj" value="{{ empresa.cnpj if empresa else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="status" class="form-label">Status*</label>
                                <select class="form-select" id="status" name="status" required>
                                    <option value="Ativo" {% if empresa and empresa.status == 'Ativo' %}selected{% endif %}>Ativo</option>
                                    <option value="Inativo" {% if empresa and empresa.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" id="telefone" name="telefone" value="{{ empresa.telefone if empresa else '' }}">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">E-mail</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ empresa.email if empresa else '' }}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="contato" class="form-label">Contato</label>
                            <input type="text" class="form-control" id="contato" name="contato" value="{{ empresa.contato if empresa else '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="endereco" class="form-label">Endere√ßo</label>
                            <input type="text" class="form-control" id="endereco" name="endereco" value="{{ empresa.endereco if empresa else '' }}">
                        </div>

                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observa√ß√µes Gerais</label>
                            <textarea class="form-control" id="observacoes" name="observacoes" rows="3">{{ empresa.observacoes if empresa else '' }}</textarea>
                        </div>

                        <!-- ============================================= -->
                        <!-- CONFIGURA√á√ïES MULTI-TENANT (Somente Admin) -->
                        <!-- ============================================= -->
                        {% if current_user.role == 'admin' %}
                        <hr>
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <i class="bi bi-database-gear"></i> <strong>Configura√ß√µes Multi-Tenant</strong>
                                <small class="text-muted">(Somente Admin)</small>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="slug_licenciado" class="form-label">
                                            <i class="bi bi-key"></i> Slug do Licenciado*
                                        </label>
                                        <input type="text" class="form-control" id="slug_licenciado" name="slug_licenciado" 
                                               value="{{ empresa.slug_licenciado if empresa else '' }}" 
                                               placeholder="Ex: lear, nsg"
                                               style="text-transform: lowercase;"
                                               pattern="[a-z0-9_]+"
                                               title="Apenas letras min√∫sculas, n√∫meros e underscore">
                                        <small class="text-muted">Usado no campo "Licenciado" do login</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="is_banco_local" class="form-label">
                                            <i class="bi bi-hdd-network"></i> Tipo de Banco
                                        </label>
                                        <select class="form-select" id="is_banco_local" name="is_banco_local" onchange="toggleBancoRemoto()">
                                            <option value="true" {% if not empresa or empresa.is_banco_local %}selected{% endif %}>
                                                üè† Banco Local (mesmo servidor)
                                            </option>
                                            <option value="false" {% if empresa and not empresa.is_banco_local %}selected{% endif %}>
                                                ‚òÅÔ∏è Banco Remoto (outro servidor)
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Campos de Banco Remoto (ocultos por padr√£o) -->
                                <div id="bancoRemotoConfig" style="display: {% if empresa and not empresa.is_banco_local %}block{% else %}none{% endif %};">
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle"></i> 
                                        Configure os dados de conex√£o com o banco de dados remoto desta empresa.
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-8 mb-3">
                                            <label for="db_host" class="form-label">Host do Banco*</label>
                                            <input type="text" class="form-control" id="db_host" name="db_host" 
                                                   value="{{ empresa.db_host if empresa else '' }}"
                                                   placeholder="Ex: dpg-xxxxx.oregon-postgres.render.com">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label for="db_port" class="form-label">Porta</label>
                                            <input type="number" class="form-control" id="db_port" name="db_port" 
                                                   value="{{ empresa.db_port if empresa else 5432 }}"
                                                   placeholder="5432">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="db_name" class="form-label">Nome do Banco*</label>
                                            <input type="text" class="form-control" id="db_name" name="db_name" 
                                                   value="{{ empresa.db_name if empresa else '' }}"
                                                   placeholder="Ex: db_nsg_homolog">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="db_user" class="form-label">Usu√°rio do Banco*</label>
                                            <input type="text" class="form-control" id="db_user" name="db_user" 
                                                   value="{{ empresa.db_user if empresa else '' }}"
                                                   placeholder="Ex: db_nsg_user">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="db_pass" class="form-label">Senha do Banco*</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="db_pass" name="db_pass" 
                                                       value="{{ empresa.db_pass if empresa else '' }}"
                                                       placeholder="Senha do banco de dados">
                                                <button class="btn btn-outline-secondary" type="button" onclick="toggleSenha()">
                                                    <i class="bi bi-eye" id="toggleSenhaIcon"></i>
                                                </button>
                                            </div>
                                            <small class="text-muted">A senha ser√° armazenada de forma segura</small>
                                        </div>
                                    </div>

                                    <!-- Bot√£o Testar Conex√£o -->
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-outline-primary" onclick="testarConexao()">
                                            <i class="bi bi-plug"></i> Testar Conex√£o
                                        </button>
                                    </div>
                                    <div id="resultadoConexao" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <hr>
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('admin.admin_dashboard', aba='empresas') }}" class="btn btn-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Toggle visibilidade dos campos de banco remoto
function toggleBancoRemoto() {
    const select = document.getElementById('is_banco_local');
    const config = document.getElementById('bancoRemotoConfig');
    
    if (select.value === 'false') {
        config.style.display = 'block';
    } else {
        config.style.display = 'none';
    }
}

// Toggle visibilidade da senha
function toggleSenha() {
    const input = document.getElementById('db_pass');
    const icon = document.getElementById('toggleSenhaIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Testar conex√£o com banco remoto
function testarConexao() {
    const host = document.getElementById('db_host').value;
    const port = document.getElementById('db_port').value;
    const name = document.getElementById('db_name').value;
    const user = document.getElementById('db_user').value;
    const pass = document.getElementById('db_pass').value;
    const resultado = document.getElementById('resultadoConexao');
    
    if (!host || !name || !user || !pass) {
        resultado.innerHTML = '<div class="alert alert-warning">Preencha todos os campos de conex√£o.</div>';
        return;
    }
    
    resultado.innerHTML = '<div class="alert alert-info"><span class="spinner-border spinner-border-sm"></span> Testando conex√£o...</div>';
    
    fetch('/testar-conexao-banco', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            db_host: host,
            db_port: port || 5432,
            db_name: name,
            db_user: user,
            db_pass: pass
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultado.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> ' + data.message + '</div>';
        } else {
            resultado.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ' + data.message + '</div>';
        }
    })
    .catch(error => {
        resultado.innerHTML = '<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Erro ao testar conex√£o</div>';
    });
}

// Converter slug para lowercase
document.getElementById('slug_licenciado')?.addEventListener('input', function(e) {
    e.target.value = e.target.value.toLowerCase().replace(/[^a-z0-9_]/g, '');
});
</script>
{% endblock %}
