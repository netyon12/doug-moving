{% extends "base.html" %}

{% block title %}Listagem de Solicitações - Go Mobi{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-warning text-white">
            <h4 class="mb-0"><i class="fas fa-list"></i> Listagem de Solicitações</h4>
        </div>
        <div class="card-body">
            <!-- Formulário de Filtros -->
            <form id="formFiltros">
                <div class="row">
                    <div class="col-md-2">
                        <label>Data Início *</label>
                        <input type="date" name="data_inicio" id="data_inicio" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label>Data Fim *</label>
                        <input type="date" name="data_fim" id="data_fim" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label>Empresa</label>
                        <select name="empresa_id" id="empresa_id" class="form-control">
                            <option value="">Todas</option>
                            {% for empresa in empresas %}
                            <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Planta</label>
                        <select name="planta_id" id="planta_id" class="form-control">
                            <option value="">Todas</option>
                            {% for planta in plantas %}
                            <option value="{{ planta.id }}">{{ planta.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Bloco</label>
                        <select name="bloco_id" id="bloco_id" class="form-control">
                            <option value="">Todos</option>
                            {% for bloco in blocos %}
                            <option value="{{ bloco.id }}">{{ bloco.nome_bloco }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Status</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">Todos</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Agrupada">Agrupada</option>
                            <option value="Finalizada">Finalizada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-2">
                        <label>Tipo Corrida</label>
                        <select name="tipo_corrida" id="tipo_corrida" class="form-control">
                            <option value="">Todos</option>
                            <option value="entrada">Entrada</option>
                            <option value="saida">Saída</option>
                            <option value="desligamento">Desligamento</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Tipo Linha</label>
                        <select name="tipo_linha" id="tipo_linha" class="form-control">
                            <option value="">Todos</option>
                            <option value="Turno">Turno</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="fas fa-eraser"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
            </form>

            <!-- Loading -->
            <div id="loading" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p>Gerando relatório...</p>
            </div>

            <!-- Área de Resultados -->
            <div id="areaResultados" class="mt-4" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Resultados: <span id="totalRegistros">0</span> solicitações</h5>
                    <div>
                        <button type="button" class="btn btn-success" onclick="exportarExcel()">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button type="button" class="btn btn-danger" onclick="exportarPDF()">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Data</th>
                                <th>Colaborador</th>
                                <th>Empresa</th>
                                <th>Planta</th>
                                <th>Bloco</th>
                                <th>Tipo Linha</th>
                                <th>Tipo Corrida</th>
                                <th>Status</th>
                                <th>Entrada</th>
                                <th>Saída</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabela">
                            <!-- Dados serão inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* Garantir que os badges tenham cores visíveis */
.badge-warning { background-color: #ffc107 !important; color: #212529 !important; }
.badge-primary { background-color: #007bff !important; color: #ffffff !important; }
.badge-success { background-color: #28a745 !important; color: #ffffff !important; }
.badge-danger { background-color: #dc3545 !important; color: #ffffff !important; }
.badge-info { background-color: #17a2b8 !important; color: #ffffff !important; }
.badge-secondary { background-color: #6c757d !important; color: #ffffff !important; }
</style>

<script>
let dadosRelatorio = [];

// Definir datas padrão
$(document).ready(function() {
    const hoje = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    
    $('#data_inicio').val(primeiroDia.toISOString().split('T')[0]);
    $('#data_fim').val(hoje.toISOString().split('T')[0]);
});

// Submeter formulário
$('#formFiltros').on('submit', function(e) {
    e.preventDefault();
    
    $('#loading').show();
    $('#areaResultados').hide();
    
    $.ajax({
        url: '{{ url_for("relatorios.dados_listagem_solicitacoes") }}',
        type: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            $('#loading').hide();
            
            if (response.success) {
                dadosRelatorio = response.dados;
                exibirResultados(response.dados, response.total);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: response.message || 'Erro ao gerar relatório'
                });
            }
        },
        error: function(xhr) {
            $('#loading').hide();
            let errorMsg = 'Erro ao gerar relatório. Tente novamente.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }


            console.error('Erro:', xhr);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: errorMsg
            });
        }
    });
});

// Exibir resultados na tabela

// Função para obter badge colorido baseado no status
function getStatusBadge(status) {
    if (!status || status === "N/A") return '<span class="badge badge-secondary">N/A</span>';
    let badgeClass = "badge-secondary";
    if (status === "Pendente") badgeClass = "badge-warning";
    else if (status === "Em andamento") badgeClass = "badge-primary";
    else if (status === "Finalizada") badgeClass = "badge-success";
    else if (status === "Cancelada") badgeClass = "badge-danger";
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

function exibirResultados(dados, total) {
    const tbody = $('#corpoTabela');
    tbody.empty();
    
    if (dados.length === 0) {
        tbody.append('<tr><td colspan="12" class="text-center">Nenhuma solicitação encontrada</td></tr>');
        $('#areaResultados').show();
        return;
    }
    
    dados.forEach(function(item) {
        const tr = $('<tr>');
        tr.append(`<td>${item.id}</td>`);
        tr.append(`<td>${item.data_criacao}</td>`);
        tr.append(`<td>${item.colaborador}</td>`);
        tr.append(`<td>${item.empresa}</td>`);
        tr.append(`<td>${item.planta}</td>`);
        tr.append(`<td>${item.bloco}</td>`);
        tr.append(`<td>${item.tipo_linha}</td>`);
        tr.append(`<td>${item.tipo_corrida}</td>`);
        tr.append(`<td>${getStatusBadge(item.status)}</td>`);
        tr.append(`<td>${item.horario_entrada}</td>`);
        tr.append(`<td>${item.horario_saida}</td>`);
        tr.append(`<td>R$ ${item.valor.toFixed(2)}</td>`);
        tbody.append(tr);
    });
    
    $('#totalRegistros').text(total);
    $('#areaResultados').show();
}

// Limpar filtros
function limparFiltros() {
    $('#formFiltros')[0].reset();
    $('#areaResultados').hide();
    
    // Redefinir datas padrão
    const hoje = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    $('#data_inicio').val(primeiroDia.toISOString().split('T')[0]);
    $('#data_fim').val(hoje.toISOString().split('T')[0]);
}

// Exportar para Excel
function exportarExcel() {
    if (dadosRelatorio.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Não há dados para exportar'
        });
        return;
    }
    
    const form = $('<form>', {
        method: 'POST',
        action: '{{ url_for("relatorios.exportar_excel", tipo="solicitacoes") }}'
    });
    
    form.append($('<input>', {
        type: 'hidden',
        name: 'dados',
        value: JSON.stringify(dadosRelatorio)
    }));
    
    $('body').append(form);
    form.submit();
    form.remove();
}

// Exportar para PDF
function exportarPDF() {
    if (dadosRelatorio.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Não há dados para exportar'
        });
        return;
    }
    
    const form = $('<form>', {
        method: 'POST',
        action: '{{ url_for("relatorios.exportar_pdf", tipo="solicitacoes") }}'
    });
    
    form.append($('<input>', {
        type: 'hidden',
        name: 'dados',
        value: JSON.stringify(dadosRelatorio)
    }));
    
    $('body').append(form);
    form.submit();
    form.remove();
}
</script>
{% endblock %}

