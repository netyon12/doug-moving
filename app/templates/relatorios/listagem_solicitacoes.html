{% extends "base.html" %}

{% block title %}Listagem de Solicitações - Go Mobi{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-warning text-white">
            <h4 class="mb-0"><i class="fas fa-list"></i> Listagem de Solicitações</h4>
        </div>
        <div class="card-body">
            <!-- Formulário de Filtros -->
            <form id="formFiltros">
                <div class="row">
                    <div class="col-md-2">
                        <label>Data Início *</label>
                        <input type="date" name="data_inicio" id="data_inicio" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label>Data Fim *</label>
                        <input type="date" name="data_fim" id="data_fim" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label>Empresa</label>
                        <!-- CORRIGIDO: Filtro fixo para não-administradores -->
                        <select name="empresa_id" id="empresa_id" class="form-control" 
                                {% if user_role != 'admin' %}disabled{% endif %}>
                            {% if empresa_id_usuario %}
                                <!-- Se usuário tem empresa fixa, mostrar apenas ela -->
                                {% for empresa in empresas %}
                                <option value="{{ empresa.id }}" selected>{{ empresa.nome }}</option>
                                {% endfor %}
                            {% else %}
                                <!-- Admin pode ver todas -->
                                <option value="">Todas</option>
                                {% for empresa in empresas %}
                                <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                        <!-- Campo hidden para enviar o valor quando disabled -->
                        {% if user_role != 'admin' and empresa_id_usuario %}
                        <input type="hidden" name="empresa_id" value="{{ empresa_id_usuario }}">
                        {% endif %}
                    </div>
                    <div class="col-md-2">
                        <label>Planta</label>
                        <select name="planta_id" id="planta_id" class="form-control">
                            <option value="">Todas</option>
                            {% for planta in plantas %}
                            <option value="{{ planta.id }}" 
                                    {% if planta_id_usuario and planta.id == planta_id_usuario %}selected{% endif %}>
                                {{ planta.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Bloco</label>
                        <select name="bloco_id" id="bloco_id" class="form-control">
                            <option value="">Todos</option>
                            {% for bloco in blocos %}
                            <!-- CORRIGIDO: Mostrar codigo_bloco ao invés de nome_bloco -->
                            <option value="{{ bloco.id }}">{{ bloco.codigo_bloco }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Status</label>
                        <select name="status" id="status" class="form-control">
                            <option value="">Todos</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Agrupada">Agrupada</option>
                            <option value="Finalizada">Finalizada</option>
                            <option value="Cancelada">Cancelada</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-2">
                        <label>Tipo Corrida</label>
                        <select name="tipo_corrida" id="tipo_corrida" class="form-control">
                            <option value="">Todos</option>
                            <option value="entrada">Entrada</option>
                            <option value="saida">Saída</option>
                            <option value="desligamento">Desligamento</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Tipo Linha</label>
                        <!-- CORRIGIDO: Opções FIXA e EXTRA -->
                        <select name="tipo_linha" id="tipo_linha" class="form-control">
                            <option value="">Todos</option>
                            <option value="FIXA">Fixa</option>
                            <option value="EXTRA">Extra</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label>Horário</label>
                        <input type="time" name="horario" id="horario" class="form-control">
                        <small class="text-muted">Opcional</small>
                    </div>
                    <!-- NOVO: Filtro de Supervisor (apenas para admin) -->
                    {% if user_role == 'admin' %}
                    <div class="col-md-3">
                        <label>Supervisor</label>
                        <select name="supervisor_id" id="supervisor_id" class="form-control">
                            <option value="">Todos</option>
                            {% for supervisor in supervisores %}
                            <option value="{{ supervisor.id }}">{{ supervisor.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Gerar Relatório
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                            <i class="fas fa-eraser"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
            </form>

            <!-- Loading -->
            <div id="loading" class="text-center mt-4" style="display: none;">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p>Gerando relatório...</p>
            </div>

            <!-- Área de Resultados -->
            <div id="areaResultados" class="mt-4" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Resultados: <span id="totalRegistros">0</span> solicitações</h5>
                    <div>
                        <button type="button" class="btn btn-success" onclick="exportarExcel()">
                            <i class="fas fa-file-excel"></i> Exportar Excel
                        </button>
                        <button type="button" class="btn btn-danger" onclick="exportarPDF()">
                            <i class="fas fa-file-pdf"></i> Exportar PDF
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="thead-dark">
                            <tr>
                                <th>ID</th>
                                <th>Data Solicitação</th>
                                <th>Colaborador</th>
                                <th>Empresa</th>
                                <th>Planta</th>
                                <th>Bloco</th>
                                <th>Tipo Linha</th>
                                <th>Tipo Corrida</th>
                                <th>Horário</th>
                                <th>Solicitante</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabela">
                            <!-- Dados serão inseridos aqui via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Controles de Paginação -->
                <div class="d-flex justify-content-between align-items-center mt-3" id="controlesPaginacao" style="display:none !important;">
                    <button id="btnAnterior" class="btn btn-secondary" onclick="navegarPagina(-1)" disabled>
                        <i class="fas fa-arrow-left"></i> Anterior
                    </button>
                    
                    <span id="infoPagina" class="text-muted">
                        Página 1 de 1 (0 registros)
                    </span>
                    
                    <button id="btnProxima" class="btn btn-secondary" onclick="navegarPagina(1)" disabled>
                        Próxima <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
/* Garantir que os badges tenham cores visíveis */
.badge-warning { background-color: #ffc107 !important; color: #212529 !important; }
.badge-primary { background-color: #007bff !important; color: #ffffff !important; }
.badge-success { background-color: #28a745 !important; color: #ffffff !important; }
.badge-danger { background-color: #dc3545 !important; color: #ffffff !important; }
.badge-info { background-color: #17a2b8 !important; color: #ffffff !important; }
.badge-secondary { background-color: #6c757d !important; color: #ffffff !important; }
</style>

<script>
let dadosRelatorio = [];
let paginaAtual = 1;
let totalPaginas = 1;
let totalRegistrosGlobal = 0;

// Definir datas padrão
$(document).ready(function() {
    const hoje = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    
    $('#data_inicio').val(primeiroDia.toISOString().split('T')[0]);
    $('#data_fim').val(hoje.toISOString().split('T')[0]);
});

// NOVO: Filtro dinâmico de Planta baseado em Empresa
$('#empresa_id').change(function() {
    var empresa_id = $(this).val();
    if (empresa_id) {
        $.get('/relatorios/plantas-por-empresa/' + empresa_id, function(data) {
            if (data.success) {
                var $planta = $('#planta_id');
                $planta.empty();
                $planta.append('<option value="">Todas</option>');
                $.each(data.plantas, function(i, planta) {
                    $planta.append($('<option></option>')
                        .attr('value', planta.id)
                        .text(planta.nome));
                });
            }
        });
    }
});

// Submeter formulário
$('#formFiltros').on('submit', function(e) {
    e.preventDefault();
    
    $('#loading').show();
    $('#areaResultados').hide();
    
    $.ajax({
        url: '{{ url_for("relatorios.dados_listagem_solicitacoes") }}',
        type: 'POST',
        data: $(this).serialize() + '&pagina=' + paginaAtual,
        success: function(response) {
            $('#loading').hide();
            
            if (response.success) {
                dadosRelatorio = response.dados;
                paginaAtual = response.pagina_atual || 1;
                totalPaginas = response.total_paginas || 1;
                totalRegistrosGlobal = response.total_registros || response.total;
                
                exibirResultados(response.dados, response.total);
                atualizarControlesPaginacao();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro',
                    text: response.message || 'Erro ao gerar relatório'
                });
            }
        },
        error: function(xhr) {
            $('#loading').hide();
            let errorMsg = 'Erro ao gerar relatório. Tente novamente.';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = xhr.responseJSON.message;
            }

            console.error('Erro:', xhr);
            Swal.fire({
                icon: 'error',
                title: 'Erro',
                text: errorMsg
            });
        }
    });
});

// Função para obter badge colorido baseado no status
function getStatusBadge(status) {
    if (!status || status === "N/A") return '<span class="badge badge-secondary">N/A</span>';
    let badgeClass = "badge-secondary";
    if (status === "Pendente") badgeClass = "badge-warning";
    else if (status === "Agrupada") badgeClass = "badge-info";
    else if (status === "Finalizada") badgeClass = "badge-success";
    else if (status === "Cancelada") badgeClass = "badge-danger";
    return `<span class="badge ${badgeClass}">${status}</span>`;
}

// Exibir resultados na tabela
function exibirResultados(dados, total) {
    const tbody = $('#corpoTabela');
    tbody.empty();
    
    if (dados.length === 0) {
        tbody.append('<tr><td colspan="11" class="text-center">Nenhuma solicitação encontrada</td></tr>');
        $('#areaResultados').show();
        return;
    }
    
    dados.forEach(function(item) {
        // Determinar horário baseado no tipo de corrida
        let horario = '-';
        if (item.tipo_corrida === 'entrada' && item.horario_entrada) {
            horario = item.horario_entrada;
        } else if (item.tipo_corrida === 'saida' && item.horario_saida) {
            horario = item.horario_saida;
        } else if (item.tipo_corrida === 'desligamento' && item.horario_desligamento) {
            horario = item.horario_desligamento;
        }
        
        const tr = $('<tr>');
        tr.append(`<td>${item.id}</td>`);
        tr.append(`<td>${item.data_criacao}</td>`);
        tr.append(`<td>${item.colaborador}</td>`);
        tr.append(`<td>${item.empresa}</td>`);
        tr.append(`<td>${item.planta}</td>`);
        tr.append(`<td>${item.bloco}</td>`);
        tr.append(`<td>${item.tipo_linha}</td>`);
        tr.append(`<td>${item.tipo_corrida}</td>`);
        tr.append(`<td>${horario}</td>`);
        tr.append(`<td>${item.solicitante}</td>`);
        tr.append(`<td>${getStatusBadge(item.status)}</td>`);
        tbody.append(tr);
    });
    
    $('#totalRegistros').text(total);
    $('#areaResultados').show();
}

// Navegar entre páginas
function navegarPagina(direcao) {
    paginaAtual += direcao;
    $('#formFiltros').submit();
}

// Atualizar controles de paginação
function atualizarControlesPaginacao() {
    if (totalPaginas > 1) {
        $('#controlesPaginacao').show();
        $('#btnAnterior').prop('disabled', paginaAtual === 1);
        $('#btnProxima').prop('disabled', paginaAtual === totalPaginas);
        $('#infoPagina').text(`Página ${paginaAtual} de ${totalPaginas} (${totalRegistrosGlobal} registros)`);
    } else {
        $('#controlesPaginacao').hide();
    }
}

// Limpar filtros
function limparFiltros() {
    paginaAtual = 1; // Reset paginação
    $('#formFiltros')[0].reset();
    $('#areaResultados').hide();
    
    // Redefinir datas padrão
    const hoje = new Date();
    const primeiroDia = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
    $('#data_inicio').val(primeiroDia.toISOString().split('T')[0]);
    $('#data_fim').val(hoje.toISOString().split('T')[0]);
}

// Exportar para Excel
function exportarExcel() {
    if (totalRegistrosGlobal === 0 && dadosRelatorio.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Não há dados para exportar'
        });
        return;
    }
    
    Swal.fire({
        title: 'Exportando...',
        text: 'Buscando todos os registros...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });
    
    var paginaAtualBackup = paginaAtual;
    paginaAtual = 0; // 0 = buscar todos
    
    $.ajax({
        url: '{{ url_for("relatorios.dados_listagem_solicitacoes") }}',
        type: 'POST',
        data: $('#formFiltros').serialize() + '&pagina=0',
        success: function(response) {
            paginaAtual = paginaAtualBackup; // Restaurar
            Swal.close();
            if (response.success) {
                const form = $('<form>', {
                    method: 'POST',
                    action: '{{ url_for("relatorios.exportar_excel", tipo="solicitacoes") }}'
                });
                form.append($('<input>', {
                    type: 'hidden',
                    name: 'dados',
                    value: JSON.stringify(response.dados)
                }));
                $('body').append(form);
                form.submit();
                form.remove();
            }
        },
        error: function() {
            paginaAtual = paginaAtualBackup;
            Swal.fire('Erro', 'Erro ao buscar dados', 'error');
        }
    });
}

// Exportar para PDF
function exportarPDF() {
    if (totalRegistrosGlobal === 0 && dadosRelatorio.length === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Atenção',
            text: 'Não há dados para exportar'
        });
        return;
    }
    
    Swal.fire({
        title: 'Exportando...',
        text: 'Buscando todos os registros...',
        allowOutsideClick: false,
        didOpen: () => { Swal.showLoading(); }
    });
    
    var paginaAtualBackup = paginaAtual;
    paginaAtual = 0;
    
    $.ajax({
        url: '{{ url_for("relatorios.dados_listagem_solicitacoes") }}',
        type: 'POST',
        data: $('#formFiltros').serialize() + '&pagina=0',
        success: function(response) {
            paginaAtual = paginaAtualBackup;
            Swal.close();
            if (response.success) {
                const form = $('<form>', {
                    method: 'POST',
                    action: '{{ url_for("relatorios.exportar_pdf", tipo="solicitacoes") }}'
                });
                form.append($('<input>', {
                    type: 'hidden',
                    name: 'dados',
                    value: JSON.stringify(response.dados)
                }));
                $('body').append(form);
                form.submit();
                form.remove();
            }
        },
        error: function() {
            paginaAtual = paginaAtualBackup;
            Swal.fire('Erro', 'Erro ao buscar dados', 'error');
        }
    });
}
</script>
{% endblock %}