{% extends "base.html" %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ titulo }}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <!-- Botão Adicionar (Estrutura correta) -->
        {% if aba_ativa == 'empresas' %}
            <a href="{{ url_for('admin.cadastrar_empresa') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Nova Empresa
            </a>
        {% elif aba_ativa == 'plantas' %}
            <a href="{{ url_for('admin.cadastrar_planta') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Nova Planta
            </a>
        {% elif aba_ativa == 'centros_custo' %}
            <a href="{{ url_for('admin.cadastrar_centro_custo') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Centro de Custo
            </a>
        {% elif aba_ativa == 'turnos' %}
            <a href="{{ url_for('admin.cadastrar_turno') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Turno
            </a>
        {% elif aba_ativa == 'blocos' %}
            <a href="{{ url_for('admin.cadastrar_bloco') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Bloco
            </a>
        {% elif aba_ativa == 'bairros' %}
            <a href="{{ url_for('admin.cadastrar_bairro') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Bairro
            </a>
        {% elif aba_ativa == 'gerentes' %}
            <a href="{{ url_for('admin.cadastrar_gerente') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Gerente
            </a>
        {% elif aba_ativa == 'supervisores' %}
            <a href="{{ url_for('admin.cadastrar_supervisor') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Supervisor
            </a>
        {% elif aba_ativa == 'colaboradores' %}
            <a href="{{ url_for('admin.cadastrar_colaborador') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Colaborador
            </a>
        {% elif aba_ativa == 'motoristas' %}
            <a href="{{ url_for('admin.cadastrar_motorista') }}" class="btn btn-sm btn-primary">
                <i class="bi bi-plus-lg"></i> Adicionar Novo Motorista
            </a>
            

        {% endif %}
    </div>
</div>

<!-- FORMULÁRIO DE BUSCA ATUALIZADO -->
{% if aba_ativa in ['blocos', 'bairros', 'gerentes', 'supervisores', 'colaboradores', 'motoristas'] %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('admin.admin_dashboard') }}">
            <input type="hidden" name="aba" value="{{ aba_ativa }}">
            <div class="input-group">
                <input type="text" class="form-control" name="busca" placeholder="Digite para buscar..." value="{{ busca or '' }}">
                <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Filtrar</button>
                <a href="{{ url_for('admin.admin_dashboard', aba=aba_ativa) }}" class="btn btn-secondary"><i class="bi bi-x-lg"></i> Limpar</a>
            </div>
        </form>
    </div>
</div>
{% endif %}



<!-- Mensagens Flash -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="table-responsive">
    <table class="table table-striped table-hover">
        
        <!-- ================================================== -->
        <!-- LÓGICA CORRIGIDA PARA CABEÇALHO E CORPO DA TABELA -->
        <!-- ================================================== -->

        {% if aba_ativa == 'empresas' %}
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>CNPJ</th>
                    <th>Telefone</th>
                    <th>Status</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.cnpj }}</td>
                    <td>{{ item.telefone }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if item.status == 'Ativo' else 'secondary' }}">
                            {{ item.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_empresa', empresa_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_empresa', empresa_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir a empresa \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">Nenhuma empresa cadastrada.</td>
                </tr>
                {% endfor %}
            </tbody>

        {% elif aba_ativa == 'plantas' %}
            <thead>
                <tr>
                    <th>Nome da Planta</th>
                    <th>Empresa</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.empresa.nome }}</td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_planta', planta_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_planta', planta_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir a planta \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" class="text-center">Nenhuma planta cadastrada.</td>
                </tr>
                {% endfor %}
            </tbody>

        {% elif aba_ativa == 'centros_custo' %}
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome do Centro de Custo</th>
                    <th>Empresa</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.codigo }}</td>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.empresa.nome }}</td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_centro_custo', cc_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_centro_custo', cc_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o centro de custo \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center">Nenhum centro de custo cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        
        {% elif aba_ativa == 'turnos' %}
            <thead>
                <tr>
                    <th>Nome do Turno</th>
                    <th>Horário</th>
                    <th>Planta</th>
                    <th>Empresa</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.horario_inicio.strftime('%H:%M') }} - {{ item.horario_fim.strftime('%H:%M') }}</td>
                    <td>{{ item.planta.nome }}</td>
                    <td>{{ item.empresa.nome }}</td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_turno', turno_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_turno', turno_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o turno \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum turno cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        
        {% elif aba_ativa == 'blocos' %}
            <thead>
                <tr>
                    <th>Código</th>
                    <th>Nome do Bloco</th>
                    <th>Empresa</th>
                    <th>Status</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.codigo_bloco }}</td>
                    <td>{{ item.nome_bloco }}</td>
                    <td>{{ item.empresa.nome }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if item.status == 'Ativo' else 'secondary' }}">
                            {{ item.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.associar_bairros_bloco', bloco_id=item.id) }}" class="btn btn-sm btn-outline-info" title="Associar Bairros"><i class="bi bi-geo-alt"></i></a>
                        <a href="{{ url_for('admin.editar_bloco', bloco_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_bloco', bloco_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o bloco \'{{ item.codigo_bloco }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum bloco cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        
        {% elif aba_ativa == 'bairros' %}
            <thead>
                <tr>
                    <th>Nome do Bairro</th>
                    <th>Cidade</th>
                    <th>Bloco Associado</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.cidade }}</td>
                    <td>
                        {% if item.bloco %}
                            <span class="badge bg-info">{{ item.bloco.codigo_bloco }}</span>
                        {% else %}
                            <span class="badge bg-secondary">Nenhum</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_bairro', bairro_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_bairro', bairro_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o bairro \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center">Nenhum bairro cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        

        {% elif aba_ativa == 'gerentes' %}
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Email (Login)</th>
                    <th>Planta</th>
                    <th>Empresa</th>
                    <th>Status</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.user.email }}</td>
                    <td>{{ item.planta.nome }}</td>
                    <td>{{ item.empresa.nome }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if item.status == 'Ativo' else 'secondary' }}">
                            {{ item.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_gerente', gerente_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_gerente', gerente_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o gerente \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">Nenhum gerente cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        
        {% elif aba_ativa == 'supervisores' %}
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Matrícula</th>
                    <th>Email (Login)</th>  
             <!--   <th>Planta</th>  -->
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.matricula }}</td>
                    <td>{{ item.user.email }}</td>
              <!--      <td>{{ item.planta.nome }}</td> -->
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_supervisor', supervisor_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_supervisor', supervisor_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o supervisor \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum supervisor cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        
        {% elif aba_ativa == 'colaboradores' %}
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Matrícula</th>
                    <th>Planta</th>
                    <th>Telefone</th>
                    <th>Status</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.matricula }}</td>
                    <td>{{ item.planta.nome }}</td>
                    <td>{{ item.telefone }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if item.status == 'Ativo' else 'secondary' }}">
                            {{ item.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_colaborador', colaborador_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_colaborador', colaborador_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o colaborador \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">Nenhum colaborador cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        
        {% elif aba_ativa == 'motoristas' %}
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Telefone</th>
                    <th>Placa</th>
                    <th>Status</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in dados %}
                <tr>
                    <td>{{ item.nome }}</td>
                    <td>{{ item.telefone }}</td>
                    <td>{{ item.placa }}</td>
                    <td>
                        <span class="badge bg-{{ 'success' if item.status == 'Ativo' else 'secondary' }}">
                            {{ item.status }}
                        </span>
                    </td>
                    <td class="text-center">
                        <a href="{{ url_for('admin.editar_motorista', motorista_id=item.id) }}" class="btn btn-sm btn-outline-secondary" title="Editar"><i class="bi bi-pencil"></i></a>
                        <form action="{{ url_for('admin.excluir_motorista', motorista_id=item.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o motorista \'{{ item.nome }}\'?');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Excluir"><i class="bi bi-trash"></i></button>
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="text-center">Nenhum motorista cadastrado.</td>
                </tr>
                {% endfor %}
            </tbody>
        

        {% endif %}
        
    </table>
</div>
{% endblock %}
