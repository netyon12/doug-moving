{% extends "base.html" %} <!-- Ou "base_admin.html" se você não consolidou -->

{% block title %}{{ 'Editar' if colaborador else 'Cadastrar' }} Colaborador{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3>{{ 'Editar Colaborador' if colaborador else 'Cadastrar Novo Colaborador' }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.editar_colaborador', colaborador_id=colaborador.id) if colaborador else url_for('admin.cadastrar_colaborador') }}">
                        
                        <h5 class="mb-3 border-bottom pb-2">Informações Pessoais e de Trabalho</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="nome" class="form-label">Nome Completo*</label>
                                <input type="text" class="form-control" id="nome" name="nome" value="{{ colaborador.nome if colaborador else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="matricula" class="form-label">Matrícula*</label>
                                <input type="text" class="form-control" id="matricula" name="matricula" value="{{ colaborador.matricula if colaborador else '' }}" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="empresa_id" class="form-label">Empresa*</label>
                                <!-- Lógica para bloquear o campo para o supervisor -->
                                <select class="form-select" name="empresa_id" required {% if current_user.role == 'supervisor' %}disabled{% endif %}>
                                    {% for empresa in empresas %}
                                        <option value="{{ empresa.id }}" 
                                                {% if (colaborador and colaborador.empresa_id == empresa.id) or (current_user.role == 'supervisor' and current_user.empresa.id == empresa.id) %}selected{% endif %}>
                                            {{ empresa.nome }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <!-- Campo oculto para enviar o valor quando o select está desabilitado -->
                                {% if current_user.role == 'supervisor' %}
                                    <input type="hidden" name="empresa_id" value="{{ current_user.empresa.id }}">
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="planta_id" class="form-label">Planta*</label>
                                <select class="form-select" name="planta_id" required {% if current_user.role == 'supervisor' %}disabled{% endif %}>
                                    {% for planta in plantas %}
                                        <option value="{{ planta.id }}" 
                                                {% if (colaborador and colaborador.planta_id == planta.id) or (current_user.role == 'supervisor' and current_user.planta.id == planta.id) %}selected{% endif %}>
                                            {{ planta.nome }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if current_user.role == 'supervisor' %}
                                    <input type="hidden" name="planta_id" value="{{ current_user.planta.id }}">
                                {% endif %}
                            </div>
                        </div>
                        
                        <h5 class="mt-4 mb-3 border-bottom pb-2">Endereço e Contato</h5>
                        <div class="row">
                            <div class="col-md-8 mb-3"><label for="endereco" class="form-label">Endereço</label><input type="text" class="form-control" id="endereco" name="endereco" value="{{ colaborador.endereco if colaborador else '' }}"></div>
                            <div class="col-md-4 mb-3"><label for="nro" class="form-label">Nº</label><input type="text" class="form-control" id="nro" name="nro" value="{{ colaborador.nro if colaborador else '' }}"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3"><label for="bairro" class="form-label">Bairro</label><input type="text" class="form-control" id="bairro" name="bairro" value="{{ colaborador.bairro if colaborador else '' }}"></div>
                            <div class="col-md-4 mb-3">
                                <label for="bloco_id" class="form-label">Bloco</label>
                                <select class="form-select" id="bloco_id" name="bloco_id">
                                    <option value="">Nenhum</option>
                                    {% for bloco in blocos %}
                                        <option value="{{ bloco.id }}" {% if colaborador and colaborador.bloco_id == bloco.id %}selected{% endif %}>
                                            {{ bloco.codigo_bloco }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3"><label for="cidade" class="form-label">Cidade</label><input type="text" class="form-control" id="cidade" name="cidade" value="{{ colaborador.cidade if colaborador else '' }}"></div>
                        </div>
                        <div class="row">
                            <div class="col-md-2 mb-3"><label for="uf" class="form-label">UF</label><input type="text" class="form-control" id="uf" name="uf" value="{{ colaborador.uf if colaborador else '' }}" maxlength="2"></div>
                            <div class="col-md-5 mb-3"><label for="telefone" class="form-label">Telefone</label><input type="tel" class="form-control" id="telefone" name="telefone" value="{{ colaborador.telefone if colaborador else '' }}"></div>
                            <div class="col-md-5 mb-3"><label for="email" class="form-label">E-mail</label><input type="email" class="form-control" id="email" name="email" value="{{ colaborador.email if colaborador else '' }}"></div>
                        </div>
                        <div class="mb-3">
                            <label for="status" class="form-label">Status*</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="Ativo" {% if colaborador and colaborador.status == 'Ativo' %}selected{% endif %}>Ativo</option>
                                <option value="Inativo" {% if colaborador and colaborador.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                            </select>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('admin.admin_dashboard', aba='colaboradores') }}" class="btn btn-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Script para preenchimento automático do Bloco baseado no Bairro
document.addEventListener('DOMContentLoaded', function() {
    const campoBairro = document.getElementById('bairro');
    const campoBloco = document.getElementById('bloco_id');
    
    if (!campoBairro || !campoBloco) {
        console.error('Campos de bairro ou bloco não encontrados');
        return;
    }
    
    // Debounce para evitar muitas requisições
    let timeoutId = null;
    
    campoBairro.addEventListener('input', function() {
        // Limpa o timeout anterior
        if (timeoutId) {
            clearTimeout(timeoutId);
        }
        
        const nomeBairro = campoBairro.value.trim();
        
        // Se o campo estiver vazio, reseta o bloco
        if (!nomeBairro) {
            campoBloco.value = '';
            return;
        }
        
        // Aguarda 500ms após o usuário parar de digitar
        timeoutId = setTimeout(function() {
            buscarBlocoPorBairro(nomeBairro);
        }, 500);
    });
    
    // Também busca quando o campo perde o foco
    campoBairro.addEventListener('blur', function() {
        const nomeBairro = campoBairro.value.trim();
        if (nomeBairro) {
            buscarBlocoPorBairro(nomeBairro);
        }
    });
    
    function buscarBlocoPorBairro(nomeBairro) {
        // Mostra feedback visual
        campoBloco.style.opacity = '0.5';
        
        // Faz a requisição para a API
        fetch(`/admin/api/buscar-bloco-por-bairro?bairro=${encodeURIComponent(nomeBairro)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Bloco não encontrado');
                }
                return response.json();
            })
            .then(data => {
                if (data.bloco_id) {
                    // Seleciona o bloco no dropdown
                    campoBloco.value = data.bloco_id;
                    
                    // Feedback visual de sucesso
                    campoBloco.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        campoBloco.style.backgroundColor = '';
                    }, 1000);
                    
                    console.log(`Bloco encontrado: ${data.bloco_codigo}`);
                } else {
                    // Bloco não encontrado
                    campoBloco.value = '';
                    console.log('Nenhum bloco associado a este bairro');
                }
            })
            .catch(error => {
                // Erro na busca
                campoBloco.value = '';
                console.log('Erro ao buscar bloco:', error.message);
            })
            .finally(() => {
                // Restaura a opacidade
                campoBloco.style.opacity = '1';
            });
    }
});
</script>

{% endblock %}