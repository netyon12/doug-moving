{% extends "base.html" %}
{% block title %}Fretados - Colaboradores{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-bus-front"></i> Fretados - Colaboradores</h1>
        <div>
            <button type="button" class="btn btn-success" onclick="exportarFretados('excel')">
                <i class="bi bi-file-earmark-excel"></i> Exportar Excel
            </button>
            <button type="button" class="btn btn-info" onclick="exportarFretados('csv')">
                <i class="bi bi-filetype-csv"></i> Exportar CSV
            </button>
        </div>
    </div>

    <!-- Formulário de Filtro -->
    <form method="GET" action="{{ url_for('admin.fretados') }}" class="mb-4 p-3 bg-light rounded border">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="data_filtro" class="form-label fw-bold">Data</label>
                <input type="date" class="form-control" id="data_filtro" name="data_filtro" 
                       value="{{ filtros.get('data_filtro', data_hoje) }}" required>
            </div>
            
            {% if current_user.role == 'admin' %}
            <div class="col-md-2">
                <label for="empresa_id" class="form-label">Empresa</label>
                <select class="form-select" id="empresa_id" name="empresa_id" onchange="filtrarPlantas()">
                    <option value="">Todas</option>
                    {% for empresa in empresas %}
                    <option value="{{ empresa.id }}" {% if filtros.get('empresa_id')|string == empresa.id|string %}selected{% endif %}>
                        {{ empresa.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label for="planta_id" class="form-label">Planta</label>
                <select class="form-select" id="planta_id" name="planta_id">
                    <option value="">Todas</option>
                    {% for planta in plantas %}
                    <option value="{{ planta.id }}" 
                            data-empresa="{{ planta.empresa_id }}"
                            {% if filtros.get('planta_id')|string == planta.id|string %}selected{% endif %}>
                        {{ planta.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
            
            <div class="col-md-2">
                <label for="bloco_id" class="form-label">Bloco</label>
                <select class="form-select" id="bloco_id" name="bloco_id">
                    <option value="">Todos</option>
                    {% for bloco in blocos %}
                    <option value="{{ bloco.id }}" {% if filtros.get('bloco_id')|string == bloco.id|string %}selected{% endif %}>
                        {{ bloco.codigo_bloco }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Filtrar
                </button>
                <a href="{{ url_for('admin.fretados') }}" class="btn btn-secondary">
                    <i class="bi bi-x-circle"></i> Limpar
                </a>
            </div>
        </div>
    </form>

    <!-- Tabela de Colaboradores em Fretados -->
    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="bi bi-people"></i> Colaboradores em Fretados
                <span class="badge bg-light text-dark float-end">{{ colaboradores_fretados|length }}</span>
            </h5>
        </div>
        <div class="card-body p-0">
            {% if colaboradores_fretados %}
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>ID Fretado</th>
                            <th>Matrícula</th>
                            <th>Nome Colaborador</th>
                            <th>Bairro</th>
                            <th>Cidade</th>
                            <th>Telefone</th>
                            <th>Empresa</th>
                            <th>Planta</th>
                            <th>Bloco</th>
                            <th>Tipo Linha</th>
                            <th>Tipo Corrida</th>
                            <th>Data/Horário</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in colaboradores_fretados %}
                        <tr>
                            <td><strong>#{{ item.fretado_id }}</strong></td>
                            <td>{{ item.matricula }}</td>
                            <td>{{ item.nome_colaborador }}</td>
                            <td>{{ item.bairro }}</td>
                            <td>{{ item.cidade }}</td>
                            <td>{{ item.telefone }}</td>
                            <td>{{ item.empresa }}</td>
                            <td>{{ item.planta }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ item.bloco }}</span>
                            </td>
                            <td>
                                {% if item.tipo_linha == 'FIXA' %}
                                <span class="badge bg-primary">FIXA</span>
                                {% elif item.tipo_linha == 'EXTRA' %}
                                <span class="badge bg-warning text-dark">EXTRA</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.tipo_corrida == 'entrada' %}
                                <span class="badge bg-success">ENTRADA</span>
                                {% elif item.tipo_corrida == 'saida' %}
                                <span class="badge bg-info">SAÍDA</span>
                                {% elif item.tipo_corrida == 'desligamento' %}
                                <span class="badge bg-danger">DESLIGAMENTO</span>
                                {% else %}
                                <span class="badge bg-secondary">N/A</span>
                                {% endif %}
                            </td>
                            <td>{{ item.data_horario }}</td>
                            <td>
                                <span class="badge bg-danger">{{ item.status }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-3">Nenhum colaborador em fretado encontrado para os filtros selecionados</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function filtrarPlantas() {
    const empresaId = document.getElementById('empresa_id').value;
    const plantaSelect = document.getElementById('planta_id');
    const options = plantaSelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
        } else {
            const plantaEmpresa = option.getAttribute('data-empresa');
            if (empresaId === '' || plantaEmpresa === empresaId) {
                option.style.display = 'block';
            } else {
                option.style.display = 'none';
            }
        }
    });
    
    // Reset planta se não for da empresa selecionada
    if (plantaSelect.value !== '') {
        const selectedOption = plantaSelect.querySelector(`option[value="${plantaSelect.value}"]`);
        if (selectedOption && selectedOption.style.display === 'none') {
            plantaSelect.value = '';
        }
    }
}

function exportarFretados(formato) {
    const params = new URLSearchParams(window.location.search);
    params.set('formato', formato);
    window.location.href = `{{ url_for('admin.exportar_fretados') }}?${params.toString()}`;
}

// Filtrar plantas ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    filtrarPlantas();
});
</script>

<style>
.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

.badge {
    font-size: 0.85em;
}

/* Ajuste para tabela com muitas colunas */
.table-responsive {
    font-size: 0.9em;
}

.table th, .table td {
    vertical-align: middle;
    white-space: nowrap;
}
</style>
{% endblock %}

