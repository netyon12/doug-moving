{% extends "base.html" %}

{% block title %}{{ 'Editar' if gerente else 'Cadastrar' }} Gerente{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3>{{ 'Editar Gerente' if gerente else 'Cadastrar Novo Gerente' }}</h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.editar_gerente', gerente_id=gerente.id) if gerente else url_for('admin.cadastrar_gerente') }}">
                        
                        <h5 class="mb-3 border-bottom pb-2">Dados de Acesso</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">E-mail (Login)*</label>
                                <input type="email" class="form-control" id="email" name="email" value="{{ gerente.user.email if gerente else '' }}" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="senha" class="form-label">Senha*</label>
                                <input type="password" 
                                        class="form-control" 
                                        id="senha" 
                                        name="senha" 
                                        {% if not gerente %}required{% endif %}
                                        placeholder="{{ '••••••••' if gerente else '' }}">
                                <small class="form-text text-muted">
                                    {% if gerente %}
                                        Preencha apenas para alterar a senha atual.
                                    {% else %}
                                        Defina a senha de acesso inicial.
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <h5 class="mt-4 mb-3 border-bottom pb-2">Informações Pessoais e de Trabalho</h5>
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome Completo*</label>
                            <input type="text" class="form-control" id="nome" name="nome" value="{{ gerente.nome if gerente else '' }}" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="empresa_id" class="form-label">Empresa*</label>
                                <select class="form-select" id="empresa_id" name="empresa_id" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    {% for empresa in empresas %}
                                        <option value="{{ empresa.id }}" {% if gerente and gerente.empresa_id == empresa.id %}selected{% endif %}>{{ empresa.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- NOVO: Campo de seleção múltipla de plantas -->
                            <div class="col-md-6 mb-3">
                                <label for="plantas_ids" class="form-label">Plantas* <small class="text-muted">(Ctrl+Click para múltiplas)</small></label>
                                <select class="form-select" id="plantas_ids" name="plantas_ids" multiple required size="5">
                                    {% if gerente %}
                                        {% set plantas_gerente_ids = gerente.plantas.all() | map(attribute='id') | list %}
                                        {% for planta in plantas %}
                                            <option value="{{ planta.id }}" {% if planta.id in plantas_gerente_ids %}selected{% endif %}>
                                                {{ planta.nome }}
                                            </option>
                                        {% endfor %}
                                    {% else %}
                                        <!-- Plantas serão carregadas dinamicamente via JavaScript após selecionar empresa -->
                                    {% endif %}
                                </select>
                                <small class="form-text text-muted">Selecione uma ou mais plantas da mesma empresa.</small>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Centros de Custo*</label>
                            <div class="card p-3" style="max-height: 200px; overflow-y: auto;">
                                {% for cc in centros_custo %}
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                            type="checkbox" 
                                            name="centros_custo" 
                                            value="{{ cc.id }}" 
                                            id="cc_{{ cc.id }}"
                                            {% if gerente and cc in gerente.centros_custo %}checked{% endif %}>
                                        <label class="form-check-label" for="cc_{{ cc.id }}">
                                            {{ cc.nome }} ({{ cc.codigo }})
                                        </label>
                                    </div>
                                {% else %}
                                    <p class="text-muted mb-0">Nenhum centro de custo cadastrado.</p>
                                {% endfor %}
                            </div>
                            <small class="form-text text-muted">Marque todos os centros de custo de responsabilidade do gerente.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="status" class="form-label">Status*</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="Ativo" {% if gerente and gerente.status == 'Ativo' %}selected{% endif %}>Ativo</option>
                                <option value="Inativo" {% if gerente and gerente.status == 'Inativo' %}selected{% endif %}>Inativo</option>
                                <option value="Desligado" {% if gerente and gerente.status == 'Desligado' %}selected{% endif %}>Desligado</option>
                                <option value="Ausente" {% if gerente and gerente.status == 'Ausente' %}selected{% endif %}>Ausente</option>
                            </select>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-end">
                            <a href="{{ url_for('admin.admin_dashboard', aba='gerentes') }}" class="btn btn-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-primary">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// JavaScript para filtrar plantas por empresa selecionada
document.addEventListener('DOMContentLoaded', function() {
    const empresaSelect = document.getElementById('empresa_id');
    const plantasSelect = document.getElementById('plantas_ids');
    
    // Armazenar todas as plantas disponíveis
    const todasPlantas = {{ plantas_json|safe }};
    
    function atualizarPlantas() {
        const empresaId = parseInt(empresaSelect.value);
        
        if (!empresaId) {
            plantasSelect.innerHTML = '<option value="" disabled>Selecione uma empresa primeiro</option>';
            return;
        }
        
        // Filtrar plantas pela empresa selecionada
        const plantasFiltradas = todasPlantas.filter(p => p.empresa_id === empresaId);
        
        // Limpar opções atuais
        plantasSelect.innerHTML = '';
        
        // Adicionar novas opções
        plantasFiltradas.forEach(planta => {
            const option = document.createElement('option');
            option.value = planta.id;
            option.textContent = planta.nome;
            
            // Manter seleção se estiver editando
            {% if gerente %}
            const plantasSelecionadas = {{ gerente_plantas_ids|safe }};
            if (plantasSelecionadas.includes(planta.id)) {
                option.selected = true;
            }
            {% endif %}
            
            plantasSelect.appendChild(option);
        });
        
        if (plantasFiltradas.length === 0) {
            plantasSelect.innerHTML = '<option value="" disabled>Nenhuma planta cadastrada para esta empresa</option>';
        }
    }
    
    // Atualizar plantas quando empresa mudar
    empresaSelect.addEventListener('change', atualizarPlantas);
    
    // Carregar plantas inicialmente se empresa já estiver selecionada
    if (empresaSelect.value) {
        atualizarPlantas();
    }
});
</script>
{% endblock %}