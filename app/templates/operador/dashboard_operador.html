{% extends "base.html" %}

{% block title %}Dashboard Operacional - Go Mobi{% endblock %}

{% block content %}
<!-- CSS específico do Dashboard Administrativo -->
<link rel="stylesheet" href="{{ url_for('static', filename='admin_dashboard.css') }}">

<!-- Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* Estilos para as abas */
.dashboard-tabs {
    background: white;
    border-radius: 12px;
    padding: 8px;
    margin-bottom: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.dashboard-tabs .nav-tabs {
    border: none;
}

.dashboard-tabs .nav-link {
    border: none;
    color: #6b7280;
    font-weight: 600;
    padding: 12px 24px;
    border-radius: 8px;
    transition: all 0.3s;
}

.dashboard-tabs .nav-link:hover {
    background: #f3f4f6;
    color: #111827;
}

.dashboard-tabs .nav-link.active {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

/* Alertas */
.alert-card {
    border-left: 4px solid;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 12px;
}

.alert-card.alert-danger {
    border-left-color: #ef4444;
    background: #fee2e2;
}

.alert-card.alert-warning {
    border-left-color: #f59e0b;
    background: #fef3c7;
}

.alert-card.alert-success {
    border-left-color: #10b981;
    background: #d1fae5;
}

/* Gráfico */
.chart-container {
    position: relative;
    height: 300px;
    margin-top: 16px;
}
</style>

<!-- Cabeçalho do Dashboard -->
<div class="dashboard-header">
    <div class="container-fluid">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="bi bi-speedometer2"></i> Dashboard Operacional
                </h1>
                <p class="mb-0 opacity-75">Visão geral operacional do sistema Go Mobi</p>
            </div>
            <div class="col-md-4 text-md-end">
                <small class="d-block opacity-75">Última atualização</small>
                <strong id="data-hora-atual"></strong>
            </div>
        </div>
    </div>
</div>

<!-- Filtros: Empresa e Período -->
<div class="company-filter mb-4">
    <form method="GET" action="{{ url_for('operador.operador_dashboard') }}" id="form_filtros">
        <input type="hidden" name="aba" id="aba_input" value="{{ request.args.get('aba', 'operacional') }}">
        <div class="row align-items-end g-3">
            <!-- Filtro de Empresa -->
            <div class="col-md-4">
                <label for="empresa_select" class="form-label fw-bold">
                    <i class="bi bi-building"></i> Empresa
                </label>
                <select id="empresa_select" name="empresa_id" class="form-select form-select-lg" onchange="this.form.submit()">
                    {% for empresa in empresas %}
                    <option value="{{ empresa.id }}" {% if empresa_selecionada and empresa.id == empresa_selecionada.id %}selected{% endif %}>
                        {{ empresa.nome }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Filtro de Data Início -->
            <div class="col-md-3">
                <label for="data_inicio" class="form-label fw-bold">
                    <i class="bi bi-calendar3"></i> Data Início
                </label>
                <input type="date" id="data_inicio" name="data_inicio" class="form-control form-control-lg" value="{{ data_inicio }}">
            </div>
            
            <!-- Filtro de Data Fim -->
            <div class="col-md-3">
                <label for="data_fim" class="form-label fw-bold">
                    <i class="bi bi-calendar3"></i> Data Fim
                </label>
                <input type="date" id="data_fim" name="data_fim" class="form-control form-control-lg" value="{{ data_fim }}">
            </div>
            
            <!-- Botões de Ação -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary btn-lg w-100">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
            </div>
        </div>
        
        <!-- Atalhos de Período -->
        <div class="row mt-2">
            <div class="col-12">
                <small class="text-muted">Atalhos:</small>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="setarPeriodo('hoje')">Hoje</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="setarPeriodo('semana')">Esta Semana</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="setarPeriodo('mes')">Este Mês</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-1" onclick="setarPeriodo('trimestre')">Trimestre</button>
            </div>
        </div>
    </form>
</div>

<!-- Abas do Dashboard -->
<div class="dashboard-tabs">
    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.args.get('aba', 'operacional') == 'operacional' %}active{% endif %}" 
                    id="operacional-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#operacional" 
                    type="button" 
                    role="tab"
                    onclick="mudarAba('operacional')">
                <i class="bi bi-speedometer2"></i> Operacional
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.args.get('aba') == 'executivo' %}active{% endif %}" 
                    id="executivo-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#executivo" 
                    type="button" 
                    role="tab"
                    onclick="mudarAba('executivo')">
                <i class="bi bi-graph-up-arrow"></i> Indicadores
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if request.args.get('aba') == 'graficos' %}active{% endif %}" 
                    id="graficos-tab" 
                    data-bs-toggle="tab" 
                    data-bs-target="#graficos" 
                    type="button" 
                    role="tab"
                    onclick="mudarAba('graficos')">
                <i class="bi bi-bar-chart-line"></i> Gráficos
            </button>
        </li>
    </ul>
</div>

<div class="tab-content" id="dashboardTabsContent">
    
    <!-- ========== ABA OPERACIONAL ========== -->
    <div class="tab-pane fade {% if request.args.get('aba', 'operacional') == 'operacional' %}show active{% endif %}" 
         id="operacional" 
         role="tabpanel">
        
        <!-- Estatísticas Gerais -->
        <div class="stats-grid mb-4">
            <div class="stat-item">
                <div class="stat-value">{{ kpis_gerais.total_empresas }}</div>
                <div class="stat-label">Total de Empresas</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ kpis_gerais.total_plantas }}</div>
                <div class="stat-label">Plantas Cadastradas</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ kpis_gerais.total_motoristas }}</div>
                <div class="stat-label">Motoristas Ativos</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ kpis_gerais.total_colaboradores }}</div>
                <div class="stat-label">Colaboradores</div>
            </div>
        </div>
        
        <!-- KPIs de Solicitações -->
        <div class="mb-4">
            <h3 class="section-title">
                <i class="bi bi-clipboard-check"></i> KPIs de Solicitações
                <small class="text-muted fs-6">(Período: {{ data_inicio }} a {{ data_fim }})</small>
            </h3>
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-solicitacoes-pendentes">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_solicitacoes.pendentes }}</div>
                            <div class="kpi-label">Pendentes</div>
                            <i class="bi bi-hourglass-split kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-solicitacoes-agrupadas">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_solicitacoes.agrupadas }}</div>
                            <div class="kpi-label">Agrupadas</div>
                            <i class="bi bi-collection kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-solicitacoes-finalizadas">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_solicitacoes.finalizadas_periodo }}</div>
                            <div class="kpi-label">Finalizadas do Período</div>
                            <i class="bi bi-check-circle kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-solicitacoes-canceladas">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_solicitacoes.canceladas_periodo }}</div>
                            <div class="kpi-label">Canceladas do Período</div>
                            <i class="bi bi-x-circle kpi-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPIs de Viagens -->
        <div class="mb-4">
            <h3 class="section-title">
                <i class="bi bi-car-front"></i> KPIs de Viagens
                <small class="text-muted fs-6">(Período: {{ data_inicio }} a {{ data_fim }})</small>
            </h3>
            <div class="row g-3">
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card kpi-card kpi-viagens-pendentes">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_viagens.pendentes }}</div>
                            <div class="kpi-label">Pendentes</div>
                            <i class="bi bi-hourglass-split kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card kpi-card kpi-viagens-agendadas">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_viagens.agendadas }}</div>
                            <div class="kpi-label">Agendadas</div>
                            <i class="bi bi-calendar-check kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card kpi-card kpi-viagens-andamento">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_viagens.em_andamento }}</div>
                            <div class="kpi-label">Em Andamento</div>
                            <i class="bi bi-arrow-repeat kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6 col-6">
                    <div class="card kpi-card kpi-viagens-finalizadas">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_viagens.finalizadas_periodo }}</div>
                            <div class="kpi-label">Finalizadas</div>
                            <i class="bi bi-check-circle kpi-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPIs de Motoristas -->
        <div class="mb-4">
            <h3 class="section-title">
                <i class="bi bi-person-badge"></i> KPIs de Motoristas
            </h3>
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-motoristas-disponiveis">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_motoristas.disponiveis }}</div>
                            <div class="kpi-label">Disponíveis</div>
                            <i class="bi bi-check-circle kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-motoristas-agendados">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_motoristas.agendados }}</div>
                            <div class="kpi-label">Agendados</div>
                            <i class="bi bi-calendar-event kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-motoristas-ocupados">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_motoristas.ocupados }}</div>
                            <div class="kpi-label">Ocupados</div>
                            <i class="bi bi-arrow-repeat kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-motoristas-offline">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_motoristas.offline }}</div>
                            <div class="kpi-label">Offline</div>
                            <i class="bi bi-power kpi-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- ========== ABA INDICADORES (EXECUTIVO LIMITADO) ========== -->
    <div class="tab-pane fade {% if request.args.get('aba') == 'executivo' %}show active{% endif %}" 
         id="executivo" 
         role="tabpanel">
        
        <!-- KPIs Operacionais (Permitidos para Operador) -->
        <div class="mb-4">
            <h3 class="section-title">
                <i class="bi bi-gear"></i> Indicadores de Performance
                <small class="text-muted fs-6">(Período: {{ data_inicio }} a {{ data_fim }})</small>
            </h3>
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-ocupacao">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_performance.taxa_ocupacao|default(0) }}%</div>
                            <div class="kpi-label">Taxa de Ocupação</div>
                            <i class="bi bi-percent kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-tempo">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_performance.tempo_medio_viagem|default(0) }} min</div>
                            <div class="kpi-label">Tempo Médio de Viagem</div>
                            <i class="bi bi-stopwatch kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-viagens-motorista">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_performance.viagens_por_motorista|default(0) }}</div>
                            <div class="kpi-label">Viagens por Motorista</div>
                            <i class="bi bi-person-check kpi-icon"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 col-sm-6">
                    <div class="card kpi-card kpi-cancelamento">
                        <div class="card-body position-relative">
                            <div class="kpi-value">{{ kpis_performance.taxa_cancelamento|default(0) }}%</div>
                            <div class="kpi-label">Taxa de Cancelamento</div>
                            <i class="bi bi-x-octagon kpi-icon"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alertas e Insights -->
        <div class="mb-4">
            <h3 class="section-title">
                <i class="bi bi-exclamation-triangle"></i> Alertas e Insights
            </h3>
            
            {% if kpis_performance.taxa_cancelamento|default(0) > 5 %}
            <div class="alert-card alert-danger">
                <strong><i class="bi bi-exclamation-circle"></i> ALERTA:</strong> 
                Taxa de cancelamento acima de 5% (atual: {{ kpis_performance.taxa_cancelamento }}%)
            </div>
            {% endif %}
            
            {% if kpis_performance.taxa_ocupacao|default(0) < 60 %}
            <div class="alert-card alert-warning">
                <strong><i class="bi bi-exclamation-triangle"></i> ATENÇÃO:</strong> 
                Taxa de ocupação abaixo de 60% (atual: {{ kpis_performance.taxa_ocupacao }}%)
            </div>
            {% endif %}
            
            {% if kpis_performance.taxa_cancelamento|default(0) <= 5 and kpis_performance.taxa_ocupacao|default(0) >= 60 %}
            <div class="alert-card alert-success">
                <strong><i class="bi bi-check-circle"></i> TUDO OK:</strong> 
                Nenhum alerta no momento. Operação dentro dos parâmetros esperados.
            </div>
            {% endif %}
        </div>
        
    </div>
    
    <!-- ========== ABA GRÁFICOS ========== -->
    <div class="tab-pane fade {% if request.args.get('aba') == 'graficos' %}show active{% endif %}" 
         id="graficos" 
         role="tabpanel" 
         aria-labelledby="graficos-tab">
        
        <h2 class="mb-4"><i class="bi bi-bar-chart-line"></i> Gráficos e Análises</h2>
        
        <!-- Gráfico 1: Receita Diária -->
        {% if dados_graficos and dados_graficos.receita_diaria %}
        <div class="mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Receita Diária do Período</h5>
                </div>
                <div class="card-body">
                    <canvas id="graficoReceitaDiaria" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        
                <!-- Gráfico 1: Viagens Finalizadas por Horário -->
        {% if dados_graficos and dados_graficos.viagens_horario %}
        <div class="mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Viagens Finalizadas por Horário</h5>
                    <span class="badge bg-light text-dark">Total: {{ dados_graficos.viagens_horario.total }}</span>
                </div>
                <div class="card-body">
                    <canvas id="graficoViagensHorario" style="max-height: 400px;"></canvas>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Gráfico 2: Viagens por Planta -->
        {% if dados_graficos and dados_graficos.viagens_planta %}
        <div class="mb-4">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-building"></i> Viagens por Planta</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div style="max-width: 400px; margin: 0 auto;">
                                <canvas id="graficoViagensPlanta"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Detalhamento por Planta</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Planta</th>
                                            <th class="text-center">Viagens</th>
                                            <th class="text-center">%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for planta in dados_graficos.viagens_planta.labels %}
                                        <tr>
                                            <td>{{ planta }}</td>
                                            <td class="text-center">
                                                <span class="badge bg-primary">{{ dados_graficos.viagens_planta.valores[loop.index0] }}</span>
                                            </td>
                                            <td class="text-center">{{ dados_graficos.viagens_planta.percentuais[loop.index0] }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Gráfico 3: Ranking de Motoristas -->
        {% if dados_graficos and dados_graficos.ranking_motoristas %}
        <div class="mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Ranking de Motoristas (Viagens Finalizadas)</h5>
                </div>
                <div class="card-body">
                    {% if dados_graficos.ranking_motoristas.motoristas|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 60px;" class="text-center">#</th>
                                    <th>Motorista</th>
                                    <th style="width: 120px;" class="text-center">Viagens</th>
                                    <th style="width: 200px;">Desempenho</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for motorista in dados_graficos.ranking_motoristas.motoristas %}
                                <tr>
                                    <td class="text-center fw-bold">
                                        {% if loop.index == 1 %}
                                            <i class="bi bi-trophy-fill text-warning"></i> 1º
                                        {% elif loop.index == 2 %}
                                            <i class="bi bi-trophy-fill text-secondary"></i> 2º
                                        {% elif loop.index == 3 %}
                                            <i class="bi bi-trophy-fill text-danger"></i> 3º
                                        {% else %}
                                            {{ loop.index }}º
                                        {% endif %}
                                    </td>
                                    <td>{{ motorista }}</td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">{{ dados_graficos.ranking_motoristas.viagens[loop.index0] }}</span>
                                    </td>
                                    <td>
                                        {% set max_viagens = dados_graficos.ranking_motoristas.viagens[0] %}
                                        {% set percentual = (dados_graficos.ranking_motoristas.viagens[loop.index0] / max_viagens * 100) if max_viagens > 0 else 0 %}
                                        <div class="progress">
                                            <div class="progress-bar {% if loop.index <= 3 %}bg-success{% else %}bg-info{% endif %}" 
                                                 role="progressbar" 
                                                 style="width: {{ percentual }}%" 
                                                 aria-valuenow="{{ percentual }}" 
                                                 aria-valuemin="0" 
                                                 aria-valuemax="100">
                                                {{ percentual|round(1) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning text-center" role="alert">
                        <i class="bi bi-exclamation-triangle"></i> Nenhuma viagem finalizada no período selecionado.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        
    </div>
    
</div>

<!-- Acesso Rápido -->
<div class="mb-4">
    <h3 class="section-title">
        <i class="bi bi-lightning"></i> Acesso Rápido
    </h3>
    <div class="row g-3">
        <div class="col-md-3 col-sm-6">
            <a href="{{ url_for('admin.solicitacoes') }}" class="card quick-access-card">
                <div class="card-body text-center">
                    <i class="bi bi-clipboard-check display-4 mb-2"></i>
                    <h5 class="card-title">Solicitações</h5>
                </div>
            </a>
        </div>
        <div class="col-md-3 col-sm-6">
            <a href="{{ url_for('admin.viagens') }}" class="card quick-access-card">
                <div class="card-body text-center">
                    <i class="bi bi-car-front display-4 mb-2"></i>
                    <h5 class="card-title">Viagens</h5>
                </div>
            </a>
        </div>
        <div class="col-md-3 col-sm-6">
            <a href="{{ url_for('admin.agrupamento') }}" class="card quick-access-card">
                <div class="card-body text-center">
                    <i class="bi bi-collection display-4 mb-2"></i>
                    <h5 class="card-title">Agrupamento</h5>
                </div>
            </a>
        </div>
        <div class="col-md-3 col-sm-6">
            <a href="{{ url_for('relatorios.conferencia_viagens') }}" class="card quick-access-card">
                <div class="card-body text-center">
                    <i class="bi bi-file-earmark-text display-4 mb-2"></i>
                    <h5 class="card-title">Relatórios</h5>
                </div>
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// ========== INICIALIZAR GRÁFICOS ==========

{% if dados_graficos and dados_graficos.receita_diaria %}
// Gráfico 1: Receita Diária
const ctxReceita = document.getElementById('graficoReceitaDiaria');
if (ctxReceita) {
    new Chart(ctxReceita, {
        type: 'line',
        data: {
            labels: {{ dados_graficos.labels_dias | tojson }},
            datasets: [{
                label: 'Receita (R$)',
                data: {{ dados_graficos.receita_diaria | tojson }},
                borderColor: 'rgb(34, 197, 94)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Receita: R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'R$ ' + value.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                        }
                    }
                }
            }
        }
    });
}
{% endif %}

{% if dados_graficos and dados_graficos.viagens_horario %}
// Gráfico 1: Viagens Finalizadas por Horário (Linha)
const ctxViagensHorario = document.getElementById('graficoViagensHorario');
if (ctxViagensHorario) {
    new Chart(ctxViagensHorario, {
        type: 'line',
        data: {
            labels: {{ dados_graficos.viagens_horario.labels | tojson }},
            datasets: [{
                label: 'Viagens Finalizadas',
                data: {{ dados_graficos.viagens_horario.valores | tojson }},
                borderColor: 'rgb(59, 130, 246)',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Viagens: ' + context.parsed.y;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}
{% endif %}

{% if dados_graficos and dados_graficos.viagens_planta %}
// Gráfico 3: Viagens por Planta (Pizza)
const ctxViagensPlanta = document.getElementById('graficoViagensPlanta');
if (ctxViagensPlanta) {
    new Chart(ctxViagensPlanta, {
        type: 'doughnut',
        data: {
            labels: {{ dados_graficos.viagens_planta.labels | tojson }},
            datasets: [{
                data: {{ dados_graficos.viagens_planta.valores | tojson }},
                backgroundColor: [
                    'rgb(59, 130, 246)',   // Azul
                    'rgb(34, 197, 94)',    // Verde
                    'rgb(249, 115, 22)',   // Laranja
                    'rgb(168, 85, 247)',   // Roxo
                    'rgb(236, 72, 153)',   // Rosa
                    'rgb(6, 182, 212)',    // Ciano
                    'rgb(251, 191, 36)',   // Amarelo
                    'rgb(239, 68, 68)'     // Vermelho
                ],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const percentuais = {{ dados_graficos.viagens_planta.percentuais | tojson }};
                            const percentage = percentuais[context.dataIndex];
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}
{% endif %}

// Atualizar data/hora atual
function atualizarDataHora() {
    const agora = new Date();
    const opcoes = { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit' 
    };
    document.getElementById('data-hora-atual').textContent = agora.toLocaleString('pt-BR', opcoes);
}
atualizarDataHora();
setInterval(atualizarDataHora, 1000);

// Função para setar período
function setarPeriodo(tipo) {
    const hoje = new Date();
    let dataInicio, dataFim;
    
    if (tipo === 'hoje') {
        dataInicio = dataFim = hoje;
    } else if (tipo === 'semana') {
        const diaSemana = hoje.getDay();
        dataInicio = new Date(hoje);
        dataInicio.setDate(hoje.getDate() - diaSemana);
        dataFim = hoje;
    } else if (tipo === 'mes') {
        dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
        dataFim = hoje;
    } else if (tipo === 'trimestre') {
        const mesAtual = hoje.getMonth();
        const inicioTrimestre = Math.floor(mesAtual / 3) * 3;
        dataInicio = new Date(hoje.getFullYear(), inicioTrimestre, 1);
        dataFim = hoje;
    }
    
    document.getElementById('data_inicio').value = dataInicio.toISOString().split('T')[0];
    document.getElementById('data_fim').value = dataFim.toISOString().split('T')[0];
    document.getElementById('form_filtros').submit();
}

// Função para mudar aba
function mudarAba(aba) {
    document.getElementById('aba_input').value = aba;
}
</script>
{% endblock %}
