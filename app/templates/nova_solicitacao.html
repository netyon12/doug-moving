{% extends "base.html" %}

{% block title %}Nova Solicita√ß√£o de Viagem{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h3>Nova Solicita√ß√£o de Viagem (Linha Extra)</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('admin.nova_solicitacao') }}">
                
                <!-- SE√á√ÉO 1: DADOS GERAIS -->
                <div class="row p-3 mb-4 bg-light rounded border">
                {% if current_user.role == 'supervisor' %}
                    <!-- Vis√£o do Supervisor: Empresa bloqueada, Planta selecion√°vel -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Empresa</label>
                        <input type="text" class="form-control" value="{{ current_user.supervisor.empresa.nome }}" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="planta_id" class="form-label fw-bold">Planta*</label>
                        {% if current_user.supervisor.plantas|length == 1 %}
                            <!-- Se supervisor tem apenas 1 planta, mostra readonly -->
                            <input type="text" class="form-control" value="{{ current_user.supervisor.plantas[0].nome }}" readonly>
                            <input type="hidden" name="planta_id" value="{{ current_user.supervisor.plantas[0].id }}">
                        {% else %}
                            <!-- Se supervisor tem m√∫ltiplas plantas, mostra select -->
                            <select class="form-select" id="planta_id" name="planta_id" required>
                                <option value="" disabled selected>Selecione...</option>
                                {% for planta in plantas_supervisor %}
                                <option value="{{ planta.id }}">{{ planta.nome }}</option>
                                {% endfor %}
                            </select>
                        {% endif %}
                    </div>
                {% elif current_user.role == 'gerente' %}
                    <!-- Vis√£o do Gerente: Empresa bloqueada, Planta selecion√°vel -->
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Empresa</label>
                        <input type="text" class="form-control" value="{{ current_user.gerente.empresa.nome }}" readonly>
                    </div>
                    <div class="col-md-4">
                        <label for="planta_id" class="form-label fw-bold">Planta*</label>
                        <select class="form-select" id="planta_id" name="planta_id" required>
                            <option value="" disabled selected>Selecione...</option>
                            {% for planta in plantas_supervisor %}
                            <option value="{{ planta.id }}">{{ planta.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                {% else %}
                        <!-- Vis√£o do Admin: Campos de Sele√ß√£o -->
                        <div class="col-md-4">
                            <label for="empresa_id" class="form-label fw-bold">Empresa*</label>
                            <select class="form-select" id="empresa_id" name="empresa_id" required>
                                <option value="" disabled selected>Selecione...</option>
                                {% for empresa in empresas %}
                                    <option value="{{ empresa.id }}">{{ empresa.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="planta_id" class="form-label fw-bold">Planta*</label>
                            <select class="form-select" id="planta_id" name="planta_id" required>
                                <option value="" disabled selected>Selecione a empresa primeiro...</option>
                                <!-- Plantas ser√£o carregadas via JS -->
                            </select>
                        </div>
                    {% endif %}

                    <div class="col-md-4">
                        <label class="form-label fw-bold">Tipo de Linha</label>
                        <input type="text" class="form-control" value="EXTRA" readonly>
                    </div>
                </div>

                <!-- SE√á√ÉO 2: TIPO DE CORRIDA -->
                <div class="row mb-4">
                    <h5 class="border-bottom pb-2 mb-3">Tipo de Corrida</h5>
                    <div class="col-md-12">
                        <label for="tipo_corrida" class="form-label fw-bold">Selecione o Tipo de Corrida*</label>
                        <select class="form-select" id="tipo_corrida" name="tipo_corrida" required>
                            <option value="" disabled selected>Selecione...</option>
                            <option value="entrada">Apenas Entrada</option>
                            <option value="saida">Apenas Sa√≠da</option>
                            <option value="entrada_saida">Entrada e Sa√≠da</option>
                            <option value="desligamento">Desligamento</option>
                        </select>
                    </div>
                </div>

                <!-- SE√á√ÉO 3: HOR√ÅRIOS PADR√ÉO (OPCIONAL) -->
                <div class="row mb-4">
                    <h5 class="border-bottom pb-2 mb-3">Hor√°rios Padr√£o (Opcional)</h5>
                    <p class="text-muted small">Preencha para aplicar o mesmo hor√°rio a todos os colaboradores adicionados.</p>
                    
                    <div class="col-md-4" id="campo_entrada">
                        <label for="default_entrada" class="form-label">Hor√°rio de Entrada</label>
                        <input type="datetime-local" class="form-control" id="default_entrada">
                    </div>
                    <div class="col-md-4" id="campo_saida">
                        <label for="default_saida" class="form-label">Hor√°rio de Sa√≠da</label>
                        <input type="datetime-local" class="form-control" id="default_saida">
                    </div>
                    <div class="col-md-4" id="campo_desligamento" style="display: none;">
                        <label for="default_desligamento" class="form-label">Hor√°rio de Desligamento</label>
                        <input type="datetime-local" class="form-control" id="default_desligamento">
                    </div>
                </div>

                <!-- SE√á√ÉO 4: SELE√á√ÉO DE COLABORADORES -->
                <div class="row mb-4">
                    <h5 class="border-bottom pb-2 mb-3">Adicionar Colaboradores</h5>
                    <div class="col-md-10">
                        <label for="colaborador_search" class="form-label">Buscar Colaborador</label>
                        <input type="text" class="form-control" id="colaborador_search" placeholder="Digite o nome ou matr√≠cula para buscar...">
                        <div id="search_results" class="list-group mt-1 position-absolute" style="z-index: 1000;"></div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" id="add_colaborador_btn" class="btn btn-success w-100">Adicionar</button>
                    </div>
                </div>

                <!-- SE√á√ÉO 5: TABELA DE SOLICITA√á√ïES -->
                <h5 class="border-bottom pb-2 mb-3">Colaboradores na Solicita√ß√£o</h5>
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Colaborador</th>
                                <th>Bloco</th>
                                <th class="campo-entrada">Hor√°rio Entrada</th>
                                <th class="campo-saida">Hor√°rio Sa√≠da</th>
                                <th class="campo-desligamento" style="display: none;">Hor√°rio Desligamento</th>
                                <th class="campo-entrada">Turno Entrada</th>
                                <th class="campo-saida">Turno Sa√≠da</th>
                                <th class="campo-desligamento" style="display: none;">Turno Desligamento</th>
                                <th class="text-center">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="solicitacoes_table_body">
                            <!-- Linhas ser√£o adicionadas dinamicamente aqui -->
                        </tbody>
                    </table>
                </div>

                <hr>
                <div class="d-flex justify-content-end">
                    <a href="{{ url_for('admin.solicitacoes') }}" class="btn btn-secondary me-2">Cancelar</a>
                    <button type="submit" class="btn btn-primary">Confirmar Solicita√ß√£o</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Template para a linha da tabela (escondido) -->
<template id="solicitacao_row_template">
    <tr>
        <td>
            <input type="hidden" name="colaborador_id[]" value="">
            <span class="colaborador_nome"></span>
        </td>
        <td><span class="bloco_codigo"></span></td>
        <td class="campo-entrada"><input type="datetime-local" class="form-control horario-entrada-input" name="horario_entrada[]"></td>
        <td class="campo-saida"><input type="datetime-local" class="form-control horario-saida-input" name="horario_saida[]"></td>
        <td class="campo-desligamento" style="display: none;"><input type="datetime-local" class="form-control horario-desligamento-input" name="horario_desligamento[]"></td>
        <td class="campo-entrada"><input type="text" class="form-control turno-entrada-field" name="turno_entrada[]" readonly></td>
        <td class="campo-saida"><input type="text" class="form-control turno-saida-field" name="turno_saida[]" readonly></td>
        <td class="campo-desligamento" style="display: none;"><input type="text" class="form-control turno-desligamento-field" name="turno_desligamento[]" readonly></td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-danger remove-row-btn">Remover</button>
        </td>
    </tr>
</template>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // =========================================================================
    // VARI√ÅVEIS GLOBAIS
    // =========================================================================
    const searchInput = document.getElementById('colaborador_search');
    const searchResults = document.getElementById('search_results');
    const addBtn = document.getElementById('add_colaborador_btn');
    const tableBody = document.getElementById('solicitacoes_table_body');
    const rowTemplate = document.getElementById('solicitacao_row_template');
    const defaultEntrada = document.getElementById('default_entrada');
    const defaultSaida = document.getElementById('default_saida');
    const defaultDesligamento = document.getElementById('default_desligamento');
    const tipoCorrida = document.getElementById('tipo_corrida');

    let selectedColaborador = null;
    let turnosPlanta = [];
    let plantaIdAtual = null;
    
    // Detecta o papel do usu√°rio e planta ID via data attributes do body
    const userRole = document.body.getAttribute('data-user-role');
    const userPlantaId = document.body.getAttribute('data-user-planta-id');

    // =========================================================================
    // L√ìGICA DO TIPO DE CORRIDA
    // =========================================================================
    tipoCorrida.addEventListener('change', function() {
        const tipo = this.value;
        
        // Campos de hor√°rios padr√£o
        const campoEntrada = document.getElementById('campo_entrada');
        const campoSaida = document.getElementById('campo_saida');
        const campoDesligamento = document.getElementById('campo_desligamento');
        
        // Colunas da tabela
        const colunasEntrada = document.querySelectorAll('.campo-entrada');
        const colunasSaida = document.querySelectorAll('.campo-saida');
        const colunasDesligamento = document.querySelectorAll('.campo-desligamento');
        
        // Reseta todos os campos
        campoEntrada.style.display = 'none';
        campoSaida.style.display = 'none';
        campoDesligamento.style.display = 'none';
        defaultEntrada.value = '';
        defaultSaida.value = '';
        defaultDesligamento.value = '';
        
        colunasEntrada.forEach(col => col.style.display = 'none');
        colunasSaida.forEach(col => col.style.display = 'none');
        colunasDesligamento.forEach(col => col.style.display = 'none');
        
        // Mostra campos baseado no tipo selecionado
        if (tipo === 'entrada') {
            campoEntrada.style.display = 'block';
            colunasEntrada.forEach(col => col.style.display = 'table-cell');
        } else if (tipo === 'saida') {
            campoSaida.style.display = 'block';
            colunasSaida.forEach(col => col.style.display = 'table-cell');
        } else if (tipo === 'entrada_saida') {
            campoEntrada.style.display = 'block';
            campoSaida.style.display = 'block';
            colunasEntrada.forEach(col => col.style.display = 'table-cell');
            colunasSaida.forEach(col => col.style.display = 'table-cell');
        } else if (tipo === 'desligamento') {
            campoDesligamento.style.display = 'block';
            colunasDesligamento.forEach(col => col.style.display = 'table-cell');
        }
        
        // Limpa a tabela ao mudar o tipo
        tableBody.innerHTML = '';
    });
    
    // Se for supervisor, carrega turnos imediatamente
    if (userRole === 'supervisor' && userPlantaId) {
        plantaIdAtual = parseInt(userPlantaId);
        carregarTurnos(plantaIdAtual);
    }
    
    // Se for admin sem planta selecionada, desabilita campo de busca
    if (userRole === 'admin' && !plantaIdAtual) {
        searchInput.disabled = true;
        searchInput.placeholder = 'Selecione uma planta primeiro';
    }

    // =========================================================================
    // L√ìGICA PARA ADMIN: CARREGAR PLANTAS E TURNOS
    // =========================================================================
    const empresaSelect = document.getElementById('empresa_id');
    const plantaSelect = document.getElementById('planta_id');

    if (empresaSelect && plantaSelect) {
        empresaSelect.addEventListener('change', function() {
            const empresaId = this.value;
            plantaSelect.innerHTML = '<option>Carregando...</option>';
            turnosPlanta = [];
            plantaIdAtual = null;

            // Busca plantas via API
            fetch('/admin/api/empresas/' + empresaId + '/plantas')
                .then(response => response.json())
                .then(plantas => {
                    plantaSelect.innerHTML = '<option value="" disabled selected>Selecione a planta...</option>';
                    plantas.forEach(planta => {
                        const option = new Option(planta.nome, planta.id);
                        plantaSelect.add(option);
                    });
                })
                .catch(error => {
                    console.error('Erro ao buscar plantas:', error);
                    plantaSelect.innerHTML = '<option value="">Erro ao carregar plantas</option>';
                });
        });

        plantaSelect.addEventListener('change', function() {
            plantaIdAtual = this.value;
            
            // Limpa colaboradores j√° adicionados quando trocar de planta
            const tbody = document.getElementById('solicitacoes_tbody');
            if (tbody && tbody.children.length > 0) {
                if (confirm('‚ö†Ô∏è Ao trocar de planta, todos os colaboradores adicionados ser√£o removidos. Deseja continuar?')) {
                    tbody.innerHTML = '';
                    colaboradoresSelecionados = [];
                } else {
                    // Reverte a sele√ß√£o
                    this.value = plantaIdAtual;
                    return;
                }
            }
            
            // Limpa campo de busca e resultados
            searchInput.value = '';
            searchResults.innerHTML = '';
            
            // Habilita/desabilita campo de busca
            if (plantaIdAtual) {
                searchInput.disabled = false;
                searchInput.placeholder = 'Digite o nome ou matr√≠cula para buscar...';
                carregarTurnos(plantaIdAtual);
            } else {
                searchInput.disabled = true;
                searchInput.placeholder = 'Selecione uma planta primeiro';
            }
        });
    }

     // =========================================================================
    // L√ìGICA PARA SUPERVISOR COM M√öLTIPLAS PLANTAS: CARREGAR TURNOS
    // =========================================================================
    // Se for supervisor e n√£o tiver plantaId definido (m√∫ltiplas plantas),
    // adiciona evento para carregar turnos quando selecionar a planta
    if (userRole === 'supervisor' && !userPlantaId && plantaSelect) {
        plantaSelect.addEventListener('change', function() {
            plantaIdAtual = this.value;
            if (plantaIdAtual) {
                console.log('Supervisor selecionou planta:', plantaIdAtual);
                carregarTurnos(plantaIdAtual);
            }
        });
    }

    // =========================================================================
    // L√ìGICA PARA GERENTE: CARREGAR TURNOS
    // =========================================================================
    // Gerente sempre tem m√∫ltiplas plantas, carrega turnos ao selecionar
    if (userRole === 'gerente' && plantaSelect) {
        plantaSelect.addEventListener('change', function() {
            plantaIdAtual = this.value;
            if (plantaIdAtual) {
                console.log('Gerente selecionou planta:', plantaIdAtual);
                carregarTurnos(plantaIdAtual);
            }
        });
    }

    // =========================================================================
    // FUN√á√ÉO: CARREGAR TURNOS DA PLANTA
    // =========================================================================
    function carregarTurnos(plantaId) {
        if (!plantaId) {
            turnosPlanta = [];
            return;
        }
        
        fetch('/admin/api/plantas/' + plantaId + '/turnos')
            .then(response => response.json())
            .then(turnos => {
                turnosPlanta = turnos;
                console.log('Turnos carregados:', turnosPlanta);
            })
            .catch(error => {
                console.error('Erro ao buscar turnos:', error);
                turnosPlanta = [];
            });
    }

    // =========================================================================
    // FUN√á√ÉO: CALCULAR TURNO BASEADO NO HOR√ÅRIO DE ENTRADA
    // =========================================================================
    function calcularTurno(horarioEntrada) {
        if (!horarioEntrada || turnosPlanta.length === 0) {
            return 'N√£o definido';
        }
        
        // Extrai apenas a hora (HH:MM) do datetime-local
        // Formato: "2025-10-07T14:27" -> "14:27"
        const horaEntrada = horarioEntrada.substring(11, 16);
        
        for (const turno of turnosPlanta) {
            const inicio = turno.horario_inicio;
            const fim = turno.horario_fim;
            
            // Caso normal: in√≠cio < fim (ex: 05:50 - 15:38)
            if (inicio < fim) {
                if (horaEntrada >= inicio && horaEntrada <= fim) {
                    return turno.nome;
                }
            }
            // Caso especial: turno atravessa meia-noite (ex: 21:12 - 06:00)
            else {
                if (horaEntrada >= inicio || horaEntrada <= fim) {
                    return turno.nome;
                }
            }
        }
        
        return 'N√£o definido';
    }

    // =========================================================================
    // L√ìGICA DE BUSCA DE COLABORADORES
    // =========================================================================
    searchInput.addEventListener('keyup', function() {
        const query = searchInput.value;
        
        // VALIDA√á√ÉO: Admin deve selecionar planta antes de buscar
        if (userRole === 'admin' && !plantaIdAtual) {
            searchResults.innerHTML = '';
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-warning';
            item.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Selecione uma planta antes de buscar colaboradores';
            searchResults.appendChild(item);
            return;
        }
        
        if (query.length < 2) {
            searchResults.innerHTML = '';
            return;
        }

        // Monta URL da API
        let url = '/admin/api/colaboradores/buscar?q=' + encodeURIComponent(query);
        
        // Se for admin, adiciona o filtro de planta
        if (userRole === 'admin' && plantaIdAtual) {
            url += '&planta_id=' + plantaIdAtual;
        }

        fetch(url)
            .then(response => response.json())
            .then(colaboradores => {
                searchResults.innerHTML = '';
                
                if (colaboradores.length === 0) {
                    const item = document.createElement('div');
                    item.className = 'list-group-item text-muted';
                    item.textContent = 'Nenhum colaborador encontrado';
                    searchResults.appendChild(item);
                    return;
                }
                
                colaboradores.forEach(function(colab) {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.textContent = colab.nome + ' (Mat: ' + colab.matricula + ') - Bloco: ' + colab.bloco;
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        searchInput.value = colab.nome + ' (' + colab.matricula + ')';
                        selectedColaborador = colab;
                        searchResults.innerHTML = '';
                    });
                    searchResults.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar colaboradores:', error);
                searchResults.innerHTML = '<div class="list-group-item text-danger">Erro ao buscar</div>';
            });
    });

    // =========================================================================
    // L√ìGICA DE ADICIONAR COLABORADOR √Ä TABELA
    // =========================================================================
    addBtn.addEventListener('click', function() {
        if (!selectedColaborador) {
            alert('Por favor, busque e selecione um colaborador.');
            return;
        }

        // ========================================================================
        // NOVA VALIDA√á√ÉO: Verificar se colaborador tem bloco cadastrado
        // ========================================================================
        if (!selectedColaborador.bloco || selectedColaborador.bloco === 'N/A' || selectedColaborador.bloco === '') {
            alert('‚ùå ERRO: O colaborador selecionado n√£o possui bloco cadastrado.\n\n' +
                'üìù Por favor, edite o cadastro do colaborador e associe-o a um bloco antes de criar a solicita√ß√£o.\n\n' +
                'üë§ Colaborador: ' + selectedColaborador.nome + '\n' +
                'üî¢ Matr√≠cula: ' + selectedColaborador.matricula + '\n\n' +
                'üí° Dica: V√° em Colaboradores ‚Üí Editar ‚Üí Selecione um Bloco ‚Üí Salvar');
            return;
        }
        // ========================================================================

        const tipo = tipoCorrida.value;
        if (!tipo) {
            alert('Por favor, selecione o tipo de corrida primeiro.');
            return;
        }

        // VERIFICA SE O COLABORADOR J√Å FOI ADICIONADO
        const colaboradoresJaAdicionados = Array.from(document.querySelectorAll('input[name="colaborador_id[]"]'));
        const jaExiste = colaboradoresJaAdicionados.some(input => input.value === String(selectedColaborador.id));
        
        if (jaExiste) {
            alert('Este colaborador j√° foi adicionado √† solicita√ß√£o!');
            searchInput.value = '';
            selectedColaborador = null;
            return;
        }

        // Clona o template
        const newRow = rowTemplate.content.cloneNode(true);
        
        // Preenche os dados da linha
        newRow.querySelector('input[name="colaborador_id[]"]').value = selectedColaborador.id;
        newRow.querySelector('.colaborador_nome').textContent = selectedColaborador.nome;
        newRow.querySelector('.bloco_codigo').textContent = selectedColaborador.bloco;
        
        // Oculta colunas baseado no tipo de corrida
        const celulasEntrada = newRow.querySelectorAll('.campo-entrada');
        const celulasSaida = newRow.querySelectorAll('.campo-saida');
        const celulasDesligamento = newRow.querySelectorAll('.campo-desligamento');
        
        // Oculta todas primeiro
        celulasEntrada.forEach(cel => cel.style.display = 'none');
        celulasSaida.forEach(cel => cel.style.display = 'none');
        celulasDesligamento.forEach(cel => cel.style.display = 'none');
        
        // Mostra apenas as relevantes
        if (tipo === 'entrada') {
            celulasEntrada.forEach(cel => cel.style.display = '');
        } else if (tipo === 'saida') {
            celulasSaida.forEach(cel => cel.style.display = '');
        } else if (tipo === 'entrada_saida') {
            celulasEntrada.forEach(cel => cel.style.display = '');
            celulasSaida.forEach(cel => cel.style.display = '');
        } else if (tipo === 'desligamento') {
            celulasDesligamento.forEach(cel => cel.style.display = '');
        }
        
        // Refer√™ncias aos inputs
        const inputEntrada = newRow.querySelector('.horario-entrada-input');
        const inputSaida = newRow.querySelector('.horario-saida-input');
        const inputDesligamento = newRow.querySelector('.horario-desligamento-input');
        const inputTurnoEntrada = newRow.querySelector('.turno-entrada-field');
        const inputTurnoSaida = newRow.querySelector('.turno-saida-field');
        const inputTurnoDesligamento = newRow.querySelector('.turno-desligamento-field');
        
        // Aplica hor√°rios padr√£o e calcula turnos baseado no tipo
        if (tipo === 'entrada' || tipo === 'entrada_saida') {
            if (defaultEntrada.value) {
                inputEntrada.value = defaultEntrada.value;
                inputTurnoEntrada.value = calcularTurno(defaultEntrada.value);
            }
            
            // Evento para recalcular turno da entrada
            inputEntrada.addEventListener('change', function() {
                // ‚úÖ Valida se a data/hora n√£o √© retroativa
                if (this.value) {
                    const dataEscolhida = new Date(this.value);
                    const agoraValidacao = new Date();
                    if (dataEscolhida < agoraValidacao) {
                        alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido selecionar data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
                        this.value = '';  // Limpa o campo
                        inputTurnoEntrada.value = '';
                        return;
                    }
                }
                inputTurnoEntrada.value = calcularTurno(this.value);
            });
        }
        
        if (tipo === 'saida' || tipo === 'entrada_saida') {
            if (defaultSaida.value) {
                inputSaida.value = defaultSaida.value;
                inputTurnoSaida.value = calcularTurno(defaultSaida.value);
            }
            
            // Evento para recalcular turno da sa√≠da
            inputSaida.addEventListener('change', function() {
                // ‚úÖ Valida se a data/hora n√£o √© retroativa
                if (this.value) {
                    const dataEscolhida = new Date(this.value);
                    const agoraValidacao = new Date();
                    if (dataEscolhida < agoraValidacao) {
                        alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido selecionar data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
                        this.value = '';  // Limpa o campo
                        inputTurnoSaida.value = '';
                        return;
                    }
                }
                inputTurnoSaida.value = calcularTurno(this.value);
            });
        }
        
        if (tipo === 'desligamento') {
            if (defaultDesligamento.value) {
                inputDesligamento.value = defaultDesligamento.value;
                inputTurnoDesligamento.value = calcularTurno(defaultDesligamento.value);
            }
            
            // Evento para recalcular turno do desligamento
            inputDesligamento.addEventListener('change', function() {
                // ‚úÖ Valida se a data/hora n√£o √© retroativa
                if (this.value) {
                    const dataEscolhida = new Date(this.value);
                    const agoraValidacao = new Date();
                    if (dataEscolhida < agoraValidacao) {
                        alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido selecionar data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
                        this.value = '';  // Limpa o campo
                        inputTurnoDesligamento.value = '';
                        return;
                    }
                }
                inputTurnoDesligamento.value = calcularTurno(this.value);
            });
        }

        // Adiciona evento de remo√ß√£o
        newRow.querySelector('.remove-row-btn').addEventListener('click', function() {
            this.closest('tr').remove();
        });

        // Adiciona a linha √† tabela
        tableBody.appendChild(newRow);

        // Limpa a sele√ß√£o para a pr√≥xima busca
        searchInput.value = '';
        selectedColaborador = null;
    });

    // =========================================================================
    // VALIDA√á√ÉO DE DATA M√çNIMA (N√ÉO PERMITIR DATAS NO PASSADO)
    // =========================================================================
    
    // ‚úÖ Define data/hora m√≠nima como AGORA (n√£o permite retroativo)
    const agora = new Date();
    
    // Formata para o formato datetime-local (YYYY-MM-DDTHH:MM)
    const ano = agora.getFullYear();
    const mes = String(agora.getMonth() + 1).padStart(2, '0');
    const dia = String(agora.getDate()).padStart(2, '0');
    const hora = String(agora.getHours()).padStart(2, '0');
    const minuto = String(agora.getMinutes()).padStart(2, '0');
    const dataHoraMinima = `${ano}-${mes}-${dia}T${hora}:${minuto}`;
    
    // ‚úÖ Fun√ß√£o para aplicar data m√≠nima em todos os campos datetime-local
    function aplicarDataMinima() {
        const camposData = document.querySelectorAll('input[type="datetime-local"]');
        camposData.forEach(campo => {
            campo.setAttribute('min', dataHoraMinima);
        });
    }
    
    // Aplica inicialmente
    aplicarDataMinima();
    
    // ‚úÖ Reaplica quando novos campos s√£o adicionados (tabela de colaboradores)
    const observer = new MutationObserver(function() {
        aplicarDataMinima();
    });
    
    // Reutiliza a vari√°vel tableBody j√° declarada anteriormente (linha ~81)
    if (tableBody) {
        observer.observe(tableBody, { childList: true, subtree: true });
    }
    
    // =========================================================================
    // VALIDA√á√ÉO NOS CAMPOS PADR√ÉO DE HOR√ÅRIO
    // =========================================================================
    
    // ‚úÖ Adiciona valida√ß√£o no campo de entrada padr√£o
    defaultEntrada.addEventListener('change', function() {
        if (this.value) {
            const dataEscolhida = new Date(this.value);
            const agoraValidacao = new Date();
            if (dataEscolhida < agoraValidacao) {
                alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido selecionar data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
                this.value = '';  // Limpa o campo
            }
        }
    });
    
    // ‚úÖ Adiciona valida√ß√£o no campo de sa√≠da padr√£o
    defaultSaida.addEventListener('change', function() {
        if (this.value) {
            const dataEscolhida = new Date(this.value);
            const agoraValidacao = new Date();
            if (dataEscolhida < agoraValidacao) {
                alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido selecionar data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
                this.value = '';  // Limpa o campo
            }
        }
    });
    
    // ‚úÖ Adiciona valida√ß√£o no campo de desligamento padr√£o
    defaultDesligamento.addEventListener('change', function() {
        if (this.value) {
            const dataEscolhida = new Date(this.value);
            const agoraValidacao = new Date();
            if (dataEscolhida < agoraValidacao) {
                alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido selecionar data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
                this.value = '';  // Limpa o campo
            }
        }
    });
    
    // =========================================================================
    // VALIDA√á√ÉO DO FORMUL√ÅRIO ANTES DO SUBMIT
    // =========================================================================
    const form = document.querySelector('form');
    
    form.addEventListener('submit', function(e) {
        // ‚úÖ VALIDA√á√ÉO 1: Verifica se h√° datas no passado (hora atual)
        const agoraSubmit = new Date();
        let temDataPassada = false;
        let campoComErro = null;
        
        // Busca TODOS os campos datetime-local no momento do submit (incluindo os da tabela)
        const todosCamposData = document.querySelectorAll('input[type="datetime-local"]');
        
        todosCamposData.forEach(campo => {
            if (campo.value) {
                const dataEscolhida = new Date(campo.value);
                if (dataEscolhida < agoraSubmit) {
                    temDataPassada = true;
                    campoComErro = campo;
                }
            }
        });
        
        if (temDataPassada) {
            e.preventDefault();
            alert('‚ö†Ô∏è Aten√ß√£o!\n\nN√£o √© permitido criar solicita√ß√µes com data/hora no passado.\n\nPor favor, selecione uma data/hora a partir de AGORA.');
            
            // Destaca o campo com erro
            if (campoComErro) {
                campoComErro.focus();
                campoComErro.style.borderColor = '#dc3545';
                campoComErro.style.borderWidth = '2px';
                setTimeout(function() {
                    campoComErro.style.borderColor = '';
                    campoComErro.style.borderWidth = '';
                }, 3000);
            }
            
            return false;
        }
        
        // VALIDA√á√ÉO 2: Verifica se h√° pelo menos um colaborador na tabela
        const tableBody = document.getElementById('solicitacoes_table_body');
        const rows = tableBody.querySelectorAll('tr');
        
        if (rows.length === 0) {
            e.preventDefault(); // Impede o envio do formul√°rio
            
            // Exibe alerta para o usu√°rio
            alert('‚ö†Ô∏è Aten√ß√£o!\n\n√â necess√°rio adicionar pelo menos um colaborador √† solicita√ß√£o.\n\n' +
                  'Por favor:\n' +
                  '1. Busque o colaborador no campo "Buscar Colaborador"\n' +
                  '2. Clique no bot√£o verde "Adicionar"\n' +
                  '3. Verifique se o colaborador aparece na tabela "Colaboradores na Solicita√ß√£o"\n' +
                  '4. Depois clique em "Confirmar Solicita√ß√£o"');
            
            // Destaca o campo de busca para chamar aten√ß√£o
            const searchInput = document.getElementById('colaborador_search');
            searchInput.focus();
            searchInput.style.borderColor = '#dc3545';
            searchInput.style.borderWidth = '2px';
            
            // Remove o destaque ap√≥s 3 segundos
            setTimeout(function() {
                searchInput.style.borderColor = '';
                searchInput.style.borderWidth = '';
            }, 3000);
            
            return false;
        }
        
        // Se chegou aqui, h√° colaboradores na tabela
        // Permite o envio do formul√°rio
        return true;
    });
});
</script>
{% endblock %}