{% extends "base.html" %}
{% block title %}Gerenciar Solicitações{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Gerenciar Solicitações de Viagem</h1>
    <a href="{{ url_for('admin.nova_solicitacao') }}" class="btn btn-primary shadow-sm">+ Nova Solicitação</a>
</div>

<!-- Formulário de Filtros - NOVO LAYOUT EM 2 LINHAS -->
<form method="GET" action="{{ url_for('admin.solicitacoes') }}" class="mb-4 p-3 bg-light rounded border">
    <!-- PRIMEIRA LINHA DE FILTROS -->
    <div class="row g-3 align-items-end mb-3">
        <div class="col-md-2">
            <label for="id_solicitacao" class="form-label">ID Solicitação</label>
            <input type="text" class="form-control" id="id_solicitacao" name="id_solicitacao" placeholder="Ex: 123" value="{{ filtros.get('id_solicitacao', '') }}">
        </div>
        
        <div class="col-md-3">
            <label for="colaborador_nome" class="form-label">Nome do Colaborador</label>
            <input type="text" class="form-control" id="colaborador_nome" name="colaborador_nome" placeholder="Digite o nome" value="{{ filtros.get('colaborador_nome', '') }}">
        </div>
        
        <div class="col-md-2">
            <label for="colaborador_matricula" class="form-label">Matrícula</label>
            <input type="text" class="form-control" id="colaborador_matricula" name="colaborador_matricula" placeholder="Ex: 12345" value="{{ filtros.get('colaborador_matricula', '') }}">
        </div>
        
        <div class="col-md-2">
            <label for="viagem_id" class="form-label">ID Viagem</label>
            <input type="text" class="form-control" id="viagem_id" name="viagem_id" placeholder="Ex: 42" value="{{ filtros.get('viagem_id', '') }}">
        </div>
        
        <div class="col-md-3">
            <label for="status" class="form-label">Status</label>
            <select class="form-select" id="status" name="status">
                <option value="">Todos</option>
                <option value="Pendente" {% if filtros.get('status') == 'Pendente' %}selected{% endif %}>Pendente</option>
                <option value="Agendada" {% if filtros.get('status') == 'Agendada' %}selected{% endif %}>Agendada</option>
                <option value="Finalizada" {% if filtros.get('status') == 'Finalizada' %}selected{% endif %}>Finalizada</option>
                <option value="Cancelada" {% if filtros.get('status') == 'Cancelada' %}selected{% endif %}>Cancelada</option>
                <option value="Fretado" {% if filtros.get('status') == 'Fretado' %}selected{% endif %}>Fretado</option>
            </select>
        </div>
    </div>

    <!-- SEGUNDA LINHA DE FILTROS -->
    <div class="row g-3 align-items-end">
        <div class="col-md-2">
            <label for="tipo_corrida" class="form-label">Tipo de Corrida</label>
            <select class="form-select" id="tipo_corrida" name="tipo_corrida">
                <option value="">Todos</option>
                <option value="entrada" {% if filtros.get('tipo_corrida') == 'entrada' %}selected{% endif %}>Entrada</option>
                <option value="saida" {% if filtros.get('tipo_corrida') == 'saida' %}selected{% endif %}>Saída</option>
                <option value="entrada_saida" {% if filtros.get('tipo_corrida') == 'entrada_saida' %}selected{% endif %}>Entrada/Saída</option>
                <option value="desligamento" {% if filtros.get('tipo_corrida') == 'desligamento' %}selected{% endif %}>Desligamento</option>
            </select>
        </div>
        
        <div class="col-md-2">
            <label for="data_inicio" class="form-label">Data Início</label>
            <input type="date" class="form-control" id="data_inicio" name="data_inicio" value="{{ filtros.get('data_inicio', '') }}">
        </div>
        
        <div class="col-md-2">
            <label for="data_fim" class="form-label">Data Fim</label>
            <input type="date" class="form-control" id="data_fim" name="data_fim" value="{{ filtros.get('data_fim', '') }}">
        </div>
        
        <div class="col-md-2">
            <label for="supervisor_id" class="form-label">Supervisor</label>
            <select class="form-select" id="supervisor_id" name="supervisor_id">
                <option value="">Todos</option>
                {% for supervisor in todos_supervisores %}
                <option value="{{ supervisor.id }}" {% if filtros.get('supervisor_id')|string == supervisor.id|string %}selected{% endif %}>
                    {{ supervisor.nome }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-2">
            <label for="bloco_id" class="form-label">Bloco</label>
            <select class="form-select" id="bloco_id" name="bloco_id">
                <option value="">Todos</option>
                {% for bloco in todos_blocos %}
                <option value="{{ bloco.id }}" {% if filtros.get('bloco_id')|string == bloco.id|string %}selected{% endif %}>
                    {{ bloco.codigo_bloco }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="col-md-1">
            <label for="planta" class="form-label">Planta</label>
            <input type="text" class="form-control" id="planta" name="planta" placeholder="Ex: Planta 1" value="{{ filtros.get('planta', '') }}">
        </div>
        
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">Filtrar</button>
        </div>
    </div>
    
    <div class="row g-3 align-items-end mt-2">
        <div class="col-md-12">
            <a href="{{ url_for('admin.solicitacoes') }}" class="btn btn-secondary">Limpar</a>
        </div>
    </div>
</form>

<!-- Tabela de Solicitações -->
<div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>ID Viagem</th>
                <th>Colaborador</th>
                <th>Matrícula</th>
                <th>Tipo</th>
                <th>Data da Viagem</th>
                <th>Bloco</th>
                <th>Supervisor</th>
                <th>Status</th>
                {% if current_user.role in ['supervisor', 'admin'] %}
                <th class="text-center">Ações</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for solicitacao in solicitacoes %}
            <tr>
                <td>{{ solicitacao.id }}</td>
                <td>{{ solicitacao.viagem_id or '-' }}</td>
                <td>{{ solicitacao.colaborador.nome if solicitacao.colaborador else 'N/A' }}</td>
                <td>{{ solicitacao.colaborador.matricula if solicitacao.colaborador else 'N/A' }}</td>
                <td>
                    {% if solicitacao.tipo_corrida %}
                        {% if solicitacao.tipo_corrida|lower == 'entrada' %}
                            <span class="badge bg-success">{{ solicitacao.tipo_corrida }}</span>
                        {% elif solicitacao.tipo_corrida|lower == 'saída' or solicitacao.tipo_corrida|lower == 'saida' %}
                            <span class="badge bg-info">{{ solicitacao.tipo_corrida }}</span>
                        {% elif solicitacao.tipo_corrida|lower == 'desligamento' %}
                            <span class="badge bg-danger">{{ solicitacao.tipo_corrida }}</span>
                        {% else %}
                            <span class="badge bg-secondary">{{ solicitacao.tipo_corrida }}</span>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">N/A</span>
                    {% endif %}
                </td>
                <td>
                    {% if solicitacao.tipo_corrida %}
                        {% if solicitacao.tipo_corrida|lower == 'entrada' or solicitacao.tipo_corrida|lower == 'entrada_saida' %}
                            {{ solicitacao.horario_entrada.strftime('%d/%m/%Y %H:%M') if solicitacao.horario_entrada else '-' }}
                        {% elif solicitacao.tipo_corrida|lower == 'saida' or solicitacao.tipo_corrida|lower == 'saída' %}
                            {{ solicitacao.horario_saida.strftime('%d/%m/%Y %H:%M') if solicitacao.horario_saida else '-' }}
                        {% elif solicitacao.tipo_corrida|lower == 'desligamento' %}
                            {{ solicitacao.horario_desligamento.strftime('%d/%m/%Y %H:%M') if solicitacao.horario_desligamento else '-' }}
                        {% else %}
                            -
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ solicitacao.colaborador.bloco.codigo_bloco if solicitacao.colaborador and solicitacao.colaborador.bloco else 'N/A' }}</td>
                <td>{{ solicitacao.supervisor.nome if solicitacao.supervisor else 'N/A' }}</td>
                <td>
                    {% if solicitacao.status == 'Pendente' %}
                        <span class="badge bg-warning text-dark">{{ solicitacao.status }}</span>
                    {% elif solicitacao.status == 'Agendada' %}
                        <span class="badge bg-info">{{ solicitacao.status }}</span>
                    {% elif solicitacao.status == 'Finalizada' %}
                        <span class="badge bg-success">{{ solicitacao.status }}</span>
                    {% elif solicitacao.status == 'Cancelada' %}
                        <span class="badge bg-danger">{{ solicitacao.status }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ solicitacao.status }}</span>
                    {% endif %}
                </td>
                {% if current_user.role in ['supervisor', 'admin'] %}
                <td class="text-center">
                    {% if solicitacao.status == 'Pendente' %}
                    <a href="{{ url_for('admin.editar_solicitacao', id=solicitacao.id) }}" class="btn btn-sm btn-warning" title="Editar">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" class="btn btn-sm btn-danger" title="Excluir" data-solicitacao-id="{{ solicitacao.id }}" onclick="confirmarExclusao(this.getAttribute('data-solicitacao-id'))">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% else %}
                    <a href="{{ url_for('admin.visualizar_solicitacao', id=solicitacao.id) }}" class="btn btn-sm btn-info" title="Visualizar">
                        <i class="bi bi-eye"></i>
                    </a>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
            {% else %}
            <tr>
                <td colspan="{% if current_user.role in ['supervisor', 'admin'] %}10{% else %}9{% endif %}" class="text-center">
                    Nenhuma solicitação encontrada.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function confirmarExclusao(solicitacaoId) {
    if (confirm('Tem certeza que deseja excluir esta solicitação? Esta ação não pode ser desfeita.')) {
        // Cria um formulário e submete
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/solicitacoes/' + solicitacaoId + '/excluir';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}